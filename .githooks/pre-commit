#!/bin/bash

# ActionDefinitionBuilder Quality Gates Pre-Commit Hook
# This hook runs quality gates for ActionDefinitionBuilder components before commits

echo "ğŸšª Running ActionDefinitionBuilder Quality Gates..."

# Get list of files being committed
FILES=$(git diff --cached --name-only --diff-filter=ACM)

if [ -z "$FILES" ]; then
    echo "â„¹ï¸ No staged files detected. Skipping checks."
    exit 0
fi

echo ""
echo "ğŸ›¡ï¸ Checking for hardcoded mod references..."
JS_FILES=$(echo "$FILES" | grep -E '\\.(js|mjs)$' || true)
if [ -n "$JS_FILES" ]; then
    if ! echo "$JS_FILES" | xargs -r npx eslint --quiet --max-warnings=0 --rule 'mod-architecture/no-hardcoded-mod-references:2'; then
        echo "âŒ Hardcoded mod references detected. Please remove non-core references or document an approved exemption."
        exit 1
    fi
else
    echo "â„¹ï¸ No staged JavaScript files detected for mod reference scanning."
fi

# Check if any ActionDefinitionBuilder-related files are being committed
ACTIONBUILDER_FILES=$(echo "$FILES" | grep -E "(src/actions/builders/|tests/.*actions/builders/|tests/performance/actions/)" || true)

if [ -z "$ACTIONBUILDER_FILES" ]; then
    echo "âœ… No ActionDefinitionBuilder files modified, skipping quality gates"
    exit 0
fi

echo "ğŸ“ ActionDefinitionBuilder files detected:"
echo "$ACTIONBUILDER_FILES" | sed 's/^/  /'

# Run linting
echo ""
echo "ğŸ” Running ESLint..."
if ! npm run lint --silent; then
    echo "âŒ ESLint failed. Please fix linting errors before committing."
    exit 1
fi

# Run TypeScript checks
echo ""
echo "ğŸ”§ Running TypeScript checks..."
if ! npm run typecheck --silent; then
    echo "âŒ TypeScript check failed. Please fix type errors before committing."
    exit 1
fi

# Run ActionDefinitionBuilder-specific tests
echo ""
echo "ğŸ§ª Running ActionDefinitionBuilder tests..."
if ! npm run test:actionbuilder --silent; then
    echo "âŒ ActionDefinitionBuilder tests failed. Please fix failing tests before committing."
    exit 1
fi

# Run quality gates
echo ""
echo "ğŸšª Running quality gates validation..."
if ! npm run quality:gates --silent; then
    echo "âŒ Quality gates failed. Please address the issues above before committing."
    echo ""
    echo "ğŸ’¡ Tips:"
    echo "  - Ensure test coverage meets minimum thresholds (95%+ for builders)"
    echo "  - Check that performance benchmarks are within limits"
    echo "  - Review code complexity and consider refactoring if needed"
    echo "  - Run 'npm run quality:actionbuilder' locally to see detailed results"
    exit 1
fi

echo ""
echo "ğŸ‰ All quality gates passed! Proceeding with commit."
exit 0
