{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "schema://living-narrative-engine/anatomy.recipe.schema.json",
  "title": "Anatomy Recipe",
  "description": "Defines what parts a creature should have (types, tags, counts, preferences, exclusions)",
  "type": "object",
  "properties": {
    "$schema": {
      "type": "string",
      "format": "uri",
      "description": "Optional. A URI reference to the schema that this document conforms to"
    },
    "recipeId": {
      "$ref": "./common.schema.json#/definitions/namespacedId",
      "description": "Unique identifier for this anatomy recipe"
    },
    "blueprintId": {
      "$ref": "./common.schema.json#/definitions/namespacedId",
      "description": "The blueprint this recipe is based on"
    },
    "slots": {
      "type": "object",
      "description": "Map of slot keys to slot configurations",
      "additionalProperties": {
        "$ref": "#/definitions/slotDefinition"
      }
    },
    "patterns": {
      "type": "array",
      "description": "Pattern-based slot configurations that can match multiple slots",
      "items": {
        "$ref": "#/definitions/patternDefinition"
      }
    },
    "constraints": {
      "type": "object",
      "description": "Global constraints for part combinations",
      "properties": {
        "requires": {
          "type": "array",
          "description": "Co-presence requirements - all parts in a group must be present together",
          "items": {
            "type": "object",
            "properties": {
              "components": {
                "type": "array",
                "description": "Component tags that must be present together",
                "items": {
                  "type": "string"
                }
              },
              "partTypes": {
                "type": "array",
                "description": "Part types that must be present together",
                "items": {
                  "type": "string"
                }
              },
              "validation": {
                "type": "object",
                "description": "Optional validation metadata for custom error messages and explanations",
                "properties": {
                  "minItems": {
                    "type": "integer",
                    "minimum": 2,
                    "description": "Minimum number of items required for co-presence constraint"
                  },
                  "errorMessage": {
                    "type": "string",
                    "description": "Custom error message to display when constraint is violated"
                  },
                  "explanation": {
                    "type": "string",
                    "description": "Explanation of why constraint exists (logged for debugging/documentation)"
                  }
                },
                "additionalProperties": false
              }
            },
            "additionalProperties": false
          }
        },
        "excludes": {
          "type": "array",
          "description": "Mutual exclusion constraints - parts in a group cannot coexist",
          "items": {
            "type": "object",
            "properties": {
              "components": {
                "type": "array",
                "description": "Component tags that cannot coexist",
                "items": {
                  "type": "string"
                }
              },
              "partTypes": {
                "type": "array",
                "description": "Part types that cannot coexist",
                "items": {
                  "type": "string"
                }
              },
              "validation": {
                "type": "object",
                "description": "Optional validation metadata for custom error messages and explanations",
                "properties": {
                  "mutuallyExclusive": {
                    "type": "boolean",
                    "description": "Indicates that listed items are mutually exclusive"
                  },
                  "errorMessage": {
                    "type": "string",
                    "description": "Custom error message to display when constraint is violated"
                  },
                  "explanation": {
                    "type": "string",
                    "description": "Explanation of why constraint exists (logged for debugging/documentation)"
                  }
                },
                "additionalProperties": false
              }
            },
            "additionalProperties": false
          }
        }
      },
      "additionalProperties": false
    },
    "initialDamage": {
      "type": "object",
      "description": "Optional per-slot seeded damage applied after anatomy generation but before description",
      "additionalProperties": {
        "$ref": "#/definitions/initialDamageEntry"
      }
    },
    "clothingEntities": {
      "type": "array",
      "description": "Clothing entities to instantiate and equip during anatomy generation",
      "items": {
        "type": "object",
        "properties": {
          "entityId": {
            "$ref": "./common.schema.json#/definitions/namespacedId",
            "description": "The clothing entity definition to instantiate",
            "examples": ["clothing:simple_shirt", "apparel:leather_boots"]
          },
          "equip": {
            "type": "boolean",
            "default": true,
            "description": "Whether to automatically equip this item after instantiation"
          },
          "targetSlot": {
            "type": "string",
            "description": "Specific clothing slot to equip to (uses entity's default if not specified)",
            "examples": ["torso_upper", "feet", "head"]
          },
          "layer": {
            "type": "string",
            "enum": ["underwear", "base", "outer", "accessories", "armor"],
            "description": "Layer override (highest precedence - overrides entity and blueprint defaults)"
          },
          "properties": {
            "type": "object",
            "description": "Property overrides for the instantiated entity",
            "additionalProperties": true,
            "examples": [
              { "color": "blue", "size": "medium" },
              { "condition": 0.8, "quality": "fine" }
            ]
          },
          "skipValidation": {
            "type": "boolean",
            "default": false,
            "description": "Skip slot compatibility validation (use with caution)"
          }
        },
        "required": ["entityId"],
        "additionalProperties": false
      }
    },
    "bodyDescriptors": {
      "type": "object",
      "description": "Optional body-level descriptors to apply to generated body",
      "properties": {
        "build": {
          "type": "string",
          "enum": [
            "skinny",
            "slim",
            "lissom",
            "toned",
            "athletic",
            "shapely",
            "hourglass",
            "thick",
            "muscular",
            "hulking",
            "stocky",
            "frail",
            "gaunt",
            "skeletal",
            "atrophied",
            "cadaverous",
            "massive",
            "willowy",
            "barrel-chested",
            "lanky"
          ]
        },
        "hairDensity": {
          "type": "string",
          "enum": [
            "hairless",
            "sparse",
            "light",
            "moderate",
            "hairy",
            "very-hairy",
            "furred"
          ],
          "description": "Body hair density (including fur for animal-like creatures)"
        },
        "composition": {
          "type": "string",
          "enum": [
            "underweight",
            "lean",
            "average",
            "soft",
            "bumpy",
            "chubby",
            "overweight",
            "obese",
            "atrophied",
            "emaciated",
            "skeletal",
            "malnourished",
            "dehydrated",
            "wasted",
            "desiccated",
            "bloated",
            "rotting"
          ]
        },
        "skinColor": {
          "type": "string"
        },
        "smell": {
          "type": "string"
        },
        "height": {
          "type": "string",
          "enum": [
            "microscopic",
            "minuscule",
            "tiny",
            "petite",
            "short",
            "average",
            "tall",
            "very-tall",
            "gigantic",
            "colossal",
            "titanic"
          ]
        }
      },
      "additionalProperties": false
    }
  },
  "required": ["recipeId", "blueprintId", "slots"],
  "additionalProperties": false,
  "definitions": {
    "initialDamageEntry": {
      "description": "Seeded damage configuration for a single slot",
      "oneOf": [
        { "$ref": "#/definitions/damageEntriesWrapper" },
        { "$ref": "#/definitions/damageShorthandEntry" }
      ]
    },
    "damageEntriesWrapper": {
      "type": "object",
      "description": "Explicit damage entries applied to the slot",
      "properties": {
        "damage_entries": {
          "type": "array",
          "description": "List of damage capability entries to apply to this slot",
          "items": {
            "$ref": "#/definitions/positiveDamageCapabilityEntry"
          },
          "minItems": 1
        }
      },
      "required": ["damage_entries"],
      "additionalProperties": false
    },
    "positiveDamageCapabilityEntry": {
      "allOf": [
        {
          "$ref": "schema://living-narrative-engine/damage-capability-entry.schema.json"
        },
        {
          "type": "object",
          "properties": {
            "amount": {
              "type": "number",
              "exclusiveMinimum": 0,
              "description": "Damage amount must be greater than zero for seeded wounds"
            }
          }
        }
      ]
    },
    "damageShorthandEntry": {
      "type": "object",
      "description": "Shorthand seeded damage using legacy damage type naming",
      "properties": {
        "amount": {
          "type": "number",
          "exclusiveMinimum": 0,
          "description": "Damage amount must be greater than zero for seeded wounds"
        },
        "name": {
          "type": "string",
          "description": "Damage type name (preferred field)"
        },
        "damage_type": {
          "type": "string",
          "description": "Legacy damage type field name"
        }
      },
      "oneOf": [
        { "required": ["amount", "name"] },
        { "required": ["amount", "damage_type"] }
      ],
      "additionalProperties": false
    },
    "slotDefinition": {
      "type": "object",
      "description": "Configuration for a single anatomy slot",
      "properties": {
        "partType": {
          "type": "string",
          "description": "Required. The type of part this slot expects (e.g., 'breast', 'leg', 'arm')"
        },
        "preferId": {
          "$ref": "./common.schema.json#/definitions/namespacedId",
          "description": "Optional. Exact entity ID to prefer if available"
        },
        "tags": {
          "type": "array",
          "description": "Component tags that must be present on matching parts",
          "items": {
            "$ref": "./common.schema.json#/definitions/namespacedId"
          }
        },
        "notTags": {
          "type": "array",
          "description": "Component tags that must NOT be present on matching parts",
          "items": {
            "$ref": "./common.schema.json#/definitions/namespacedId"
          }
        },
        "properties": {
          "type": "object",
          "description": "Filters entities by exact component property values. NOT for runtime overrides.",
          "additionalProperties": true
        }
      },
      "required": ["partType"],
      "additionalProperties": false
    },
    "patternDefinition": {
      "description": "Pattern-based slot configuration supporting v1 (explicit matches) and v2 (enhanced matchers)",
      "oneOf": [
        { "$ref": "#/definitions/v1PatternDefinition" },
        { "$ref": "#/definitions/enhancedPatternDefinition" }
      ]
    },
    "v1PatternDefinition": {
      "type": "object",
      "description": "V1 pattern with explicit slot list (backward compatible)",
      "properties": {
        "matches": {
          "type": "array",
          "description": "List of slot keys this pattern applies to",
          "items": {
            "type": "string"
          },
          "minItems": 1
        },
        "partType": {
          "type": "string",
          "description": "Required. The type of part these slots expect"
        },
        "preferId": {
          "$ref": "./common.schema.json#/definitions/namespacedId",
          "description": "Optional. Exact entity ID to prefer if available"
        },
        "tags": {
          "type": "array",
          "description": "Component tags that must be present on matching parts",
          "items": {
            "$ref": "./common.schema.json#/definitions/namespacedId"
          }
        },
        "notTags": {
          "type": "array",
          "description": "Component tags that must NOT be present on matching parts",
          "items": {
            "$ref": "./common.schema.json#/definitions/namespacedId"
          }
        },
        "properties": {
          "type": "object",
          "description": "Filters entities by exact component property values. NOT for runtime overrides.",
          "additionalProperties": true
        }
      },
      "required": ["matches", "partType"],
      "additionalProperties": false
    },
    "enhancedPatternDefinition": {
      "type": "object",
      "description": "V2 pattern with enhanced matchers: slot groups, wildcards, property filters. NOTE: Each pattern can have ONLY ONE matcher (matchesGroup, matchesPattern, or matchesAll).",
      "properties": {
        "matchesGroup": {
          "type": "string",
          "pattern": "^(limbSet|appendage):[a-z0-9_]+$",
          "description": "Slot group selector from structure template topology: 'limbSet:leg' or 'appendage:tail'. REQUIRES blueprint with schemaVersion '2.0' and structureTemplate property."
        },
        "matchesPattern": {
          "type": "string",
          "pattern": "^(?:\\*?[a-z0-9_]+(?:\\*[a-z0-9_]+)*\\*?)$",
          "minLength": 1,
          "description": "Wildcard pattern for slot key matching: 'leg_*', 'tentacle_*', 'wing_*'. Pattern must be non-empty string."
        },
        "matchesAll": {
          "type": "object",
          "properties": {
            "slotType": {
              "type": "string",
              "description": "Filter by slot part type"
            },
            "orientation": {
              "type": "string",
              "description": "Filter by orientation (supports wildcards: 'left_*')"
            },
            "socketId": {
              "type": "string",
              "description": "Filter by socket ID pattern"
            }
          },
          "minProperties": 1,
          "additionalProperties": false,
          "description": "Property-based slot matching"
        },
        "partType": {
          "type": "string",
          "description": "Required. The type of part to use for matched slots"
        },
        "preferId": {
          "$ref": "./common.schema.json#/definitions/namespacedId",
          "description": "Optional. Exact entity ID to prefer if available"
        },
        "tags": {
          "type": "array",
          "description": "Component tags that must be present on matching parts",
          "items": {
            "$ref": "./common.schema.json#/definitions/namespacedId"
          }
        },
        "notTags": {
          "type": "array",
          "description": "Component tags that must NOT be present on matching parts",
          "items": {
            "$ref": "./common.schema.json#/definitions/namespacedId"
          }
        },
        "properties": {
          "type": "object",
          "description": "Filters entities by exact component property values. NOT for runtime overrides.",
          "additionalProperties": true
        },
        "exclude": {
          "type": "object",
          "properties": {
            "slotGroups": {
              "type": "array",
              "items": {
                "type": "string",
                "pattern": "^(limbSet|appendage):[a-z0-9_]+$"
              },
              "minItems": 1,
              "description": "Slot groups to exclude from matching (format: 'limbSet:leg' or 'appendage:tail')"
            },
            "properties": {
              "type": "object",
              "description": "Property-based exclusion criteria. Must be a valid object with slot property filters.",
              "additionalProperties": true,
              "not": { "type": "null" }
            }
          },
          "additionalProperties": false,
          "description": "Pattern-level exclusion criteria. Removes specific slots from the pattern's matched set."
        }
      },
      "oneOf": [
        { "required": ["matchesGroup", "partType"] },
        { "required": ["matchesPattern", "partType"] },
        { "required": ["matchesAll", "partType"] }
      ],
      "additionalProperties": false
    }
  }
}
