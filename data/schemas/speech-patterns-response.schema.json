{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "schema://living-narrative-engine/speech-patterns-response.schema.json",
  "title": "Speech Patterns Response Schema",
  "description": "Validates the response from LLM for speech patterns generation, ensuring quality and structure compliance",
  "type": "object",

  "properties": {
    "characterName": {
      "type": "string",
      "description": "Name of the character these patterns are for",
      "minLength": 1,
      "maxLength": 100,
      "pattern": "^[^<>\"'&]*$"
    },

    "speechPatterns": {
      "type": "array",
      "description": "Array of generated speech pattern groups for the character",
      "minItems": 3,
      "maxItems": 8,
      "items": {
        "$ref": "#/definitions/SpeechPatternGroup"
      }
    },

    "generatedAt": {
      "type": "string",
      "format": "date-time",
      "description": "ISO 8601 timestamp of when patterns were generated"
    },

    "metadata": {
      "type": "object",
      "description": "Optional metadata about the generation process",
      "properties": {
        "processingMethod": {
          "type": "string",
          "enum": ["json", "text_parsing", "hybrid"],
          "description": "Method used to process the LLM response"
        },
        "patternCount": {
          "type": "integer",
          "minimum": 0,
          "description": "Total number of pattern groups generated"
        },
        "averagePatternLength": {
          "type": "integer",
          "minimum": 0,
          "description": "Average length of pattern type descriptions"
        },
        "averageExampleLength": {
          "type": "integer",
          "minimum": 0,
          "description": "Average length of pattern examples"
        },
        "patternsWithCircumstances": {
          "type": "integer",
          "minimum": 0,
          "description": "Number of pattern groups that include contexts"
        },
        "qualityScore": {
          "type": "number",
          "minimum": 0,
          "maximum": 1,
          "description": "Quality score for the generated patterns (0-1)"
        }
      },
      "additionalProperties": false
    }
  },

  "required": ["characterName", "speechPatterns"],
  "additionalProperties": false,

  "definitions": {
    "SpeechPatternGroup": {
      "type": "object",
      "description": "Speech pattern group with type, optional contexts, and examples",
      "properties": {
        "type": {
          "type": "string",
          "description": "The type or category of this speech pattern (e.g., 'Tonal Shifts', 'Verbal Tics')",
          "minLength": 5,
          "maxLength": 500,
          "pattern": "^[^<>]*$"
        },

        "contexts": {
          "type": "array",
          "description": "Optional array of context strings indicating when this pattern is typically used",
          "items": {
            "type": "string",
            "minLength": 1,
            "maxLength": 200,
            "pattern": "^[^<>]*$"
          },
          "default": []
        },

        "examples": {
          "type": "array",
          "description": "Array of concrete dialogue examples demonstrating this speech pattern",
          "minItems": 2,
          "maxItems": 5,
          "items": {
            "type": "string",
            "minLength": 3,
            "maxLength": 1000,
            "pattern": "^[^<>]*$"
          }
        }
      },

      "required": ["type", "examples"],
      "additionalProperties": false,

      "allOf": [
        {
          "description": "Content quality validation for pattern type descriptions",
          "properties": {
            "type": {
              "not": {
                "pattern": "^(says|talks|speaks|has a way of speaking)\\b"
              }
            }
          }
        },
        {
          "description": "Content quality validation for examples",
          "properties": {
            "examples": {
              "items": {
                "anyOf": [
                  { "pattern": "['\"].*['\"]" },
                  { "pattern": "\\(.*\\).*['\"].*['\"]" }
                ]
              }
            }
          }
        },
        {
          "if": {
            "properties": {
              "contexts": {
                "type": "array",
                "minItems": 1
              }
            }
          },
          "then": {
            "properties": {
              "contexts": {
                "items": {
                  "minLength": 5,
                  "pattern": "^(When|During|In|While|After|Before|If)\\b",
                  "description": "Contexts should be descriptive and start with appropriate temporal/conditional words"
                }
              }
            }
          }
        }
      ]
    }
  },

  "allOf": [
    {
      "description": "Ensure at least one substantial pattern exists",
      "properties": {
        "speechPatterns": {
          "contains": {
            "type": "object",
            "properties": {
              "type": {
                "minLength": 10
              },
              "examples": {
                "minItems": 2,
                "items": {
                  "minLength": 10
                }
              }
            },
            "required": ["type", "examples"]
          }
        }
      }
    },
    {
      "description": "Security validation to prevent XSS and injection attacks",
      "properties": {
        "characterName": {
          "not": {
            "pattern": "<[Ss][Cc][Rr][Ii][Pp][Tt]|[Jj][Aa][Vv][Aa][Ss][Cc][Rr][Ii][Pp][Tt]:|[Oo][Nn]\\w+\\s*="
          }
        }
      }
    }
  ],

  "examples": [
    {
      "characterName": "Sarah Mitchell",
      "speechPatterns": [
        {
          "type": "Uses elaborate metaphors when explaining complex emotions",
          "contexts": ["When trying to articulate deep emotional pain"],
          "examples": [
            "\"It's like... imagine your favorite song being played backwards on a broken record player.\"",
            "\"My heart feels like it's being squeezed through a pasta maker.\""
          ]
        },
        {
          "type": "Switches to clipped, military-style speech under pressure",
          "contexts": [
            "During high-stress situations requiring quick decisions"
          ],
          "examples": [
            "\"Copy that. Moving to position. ETA two minutes.\"",
            "\"Affirmative. Proceeding with plan B.\""
          ]
        },
        {
          "type": "Tends to use technical jargon as emotional armor",
          "contexts": [],
          "examples": [
            "\"I need to recalibrate my approach to this situation.\"",
            "\"Let me optimize my emotional response parameters.\""
          ]
        }
      ],
      "generatedAt": "2025-08-25T10:30:00Z",
      "metadata": {
        "processingMethod": "json",
        "patternCount": 3,
        "averagePatternLength": 65,
        "averageExampleLength": 85,
        "patternsWithCircumstances": 2,
        "qualityScore": 0.87
      }
    }
  ]
}
