{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "schema://living-narrative-engine/expression.schema.json",
  "title": "Expression Definition",
  "description": "Defines an expression that generates narrative perception log entries when an actor's emotional or sexual state matches specified prerequisites. Expressions are evaluated after mood/sexual state changes and dispatched as perceptible events.",
  "type": "object",
  "properties": {
    "$schema": {
      "$ref": "./common.schema.json#/definitions/BaseDefinition/properties/$schema"
    },
    "id": {
      "$ref": "./common.schema.json#/definitions/BaseDefinition/properties/id"
    },
    "description": {
      "$ref": "./common.schema.json#/definitions/BaseDefinition/properties/description"
    },
    "priority": {
      "type": "integer",
      "minimum": 0,
      "maximum": 100,
      "default": 50,
      "description": "Priority for expression selection when multiple expressions match (0-100). Higher priority wins. Ties resolved by mod load order."
    },
    "prerequisites": {
      "type": "array",
      "description": "Array of JSON Logic rules that must ALL pass for this expression to trigger. Context includes: actor (proxy), emotions (calculated), sexualStates (calculated), moodAxes (raw), sexualArousal (calculated), previousEmotions, previousSexualStates, previousMoodAxes.",
      "items": {
        "type": "object",
        "properties": {
          "logic": {
            "$ref": "./condition-container.schema.json#",
            "description": "JSON Logic rule or condition reference to evaluate."
          },
          "failure_message": {
            "type": "string",
            "description": "Optional message explaining why this prerequisite failed (for debugging)."
          }
        },
        "required": ["logic"],
        "additionalProperties": false
      },
      "default": []
    },
    "actor_description": {
      "type": "string",
      "minLength": 1,
      "description": "First-person narrative text from the actor's perspective describing their internal experience of this emotional/sexual state."
    },
    "description_text": {
      "type": "string",
      "minLength": 1,
      "description": "Third-person narrative text describing the actor's observable expression. Use {actor} placeholder for the actor's name."
    },
    "alternate_descriptions": {
      "type": "object",
      "description": "Optional sense-specific descriptions for actors who cannot visually observe the expression.",
      "properties": {
        "auditory": {
          "type": "string",
          "minLength": 1,
          "description": "Description for auditory perception (sighs, breathing changes, vocal tremors)."
        },
        "tactile": {
          "type": "string",
          "minLength": 1,
          "description": "Description for tactile perception (trembling, tension, warmth)."
        },
        "olfactory": {
          "type": "string",
          "minLength": 1,
          "description": "Description for olfactory perception (stress sweat, pheromones)."
        },
        "limited": {
          "type": "string",
          "minLength": 1,
          "description": "Fallback description when primary senses are unavailable."
        }
      },
      "additionalProperties": false
    },
    "perception_type": {
      "type": "string",
      "default": "emotion.expression",
      "description": "The perception type for this expression event. Defaults to 'emotion.expression'. Must be registered in the perception type registry."
    },
    "tags": {
      "type": "array",
      "description": "Optional tags for categorization and filtering (e.g., ['anger', 'intense', 'visible']).",
      "items": {
        "type": "string",
        "minLength": 1
      },
      "uniqueItems": true
    }
  },
  "required": ["id", "description", "actor_description", "description_text"],
  "additionalProperties": false
}
