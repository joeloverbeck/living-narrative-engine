{
  "$schema": "schema://living-narrative-engine/rule.schema.json",
  "rule_id": "handle_extract_spiritual_corruption",
  "event_type": "core:attempt_action",
  "condition": {
    "condition_ref": "warding:event-is-action-extract-spiritual-corruption"
  },
  "actions": [
    {
      "type": "GET_NAME",
      "parameters": { "entity_ref": "actor", "result_variable": "actorName" }
    },
    {
      "type": "GET_NAME",
      "parameters": { "entity_ref": "primary", "result_variable": "targetName" }
    },
    {
      "type": "GET_NAME",
      "parameters": { "entity_ref": "secondary", "result_variable": "anchorName" }
    },
    {
      "type": "QUERY_COMPONENT",
      "parameters": {
        "entity_ref": "actor",
        "component_type": "core:position",
        "result_variable": "actorPosition"
      }
    },
    {
      "type": "RESOLVE_OUTCOME",
      "comment": "Opposed contest using warding_skill vs target resolve_skill",
      "parameters": {
        "actor_skill_component": "skills:warding_skill",
        "target_skill_component": "skills:resolve_skill",
        "actor_skill_default": 10,
        "target_skill_default": 0,
        "formula": "ratio",
        "result_variable": "extractionResult",
        "target_role": "primary"
      }
    },
    {
      "type": "SET_VARIABLE",
      "comment": "Shared context for macros and perception",
      "parameters": {
        "variable_name": "locationId",
        "value": "{context.actorPosition.locationId}"
      }
    },
    {
      "type": "SET_VARIABLE",
      "parameters": { "variable_name": "perceptionType", "value": "action_target_general" }
    },
    {
      "type": "SET_VARIABLE",
      "parameters": {
        "variable_name": "targetId",
        "value": "{event.payload.primaryId}"
      }
    },
    {
      "type": "IF",
      "comment": "Handle CRITICAL_SUCCESS outcome",
      "parameters": {
        "condition": {
          "==": [
            { "var": "context.extractionResult.outcome" },
            "CRITICAL_SUCCESS"
          ]
        },
        "then_actions": [
          {
            "type": "REMOVE_COMPONENT",
            "parameters": {
              "entity_ref": "primary",
              "component_type": "warding:corrupted"
            }
          },
          { "type": "REGENERATE_DESCRIPTION", "parameters": { "entity_ref": "primary" } },
        {
          "type": "DISPATCH_PERCEPTIBLE_EVENT",
          "parameters": {
            "location_id": "{context.actorPosition.locationId}",
            "description_text": "{context.actorName} extracts the corruption out of {context.targetName} swiftly using {context.anchorName}. Light returns to {context.targetName}'s eyes.",
            "perception_type": "action_target_general",
            "actor_id": "{event.payload.actorId}",
            "target_id": "{event.payload.primaryId}",
            "contextual_data": {
              "excludedActorIds": ["{event.payload.primaryId}"]
            }
          }
        },
        {
          "type": "DISPATCH_PERCEPTIBLE_EVENT",
          "parameters": {
            "location_id": "{context.actorPosition.locationId}",
            "description_text": "{context.actorName} uses {context.anchorName} against me, and suddenly I feel like I'm being burned alive from the inside as something dark rushes out of me. Then it ends. My insides are cleaner, but I feel like I've suffered through a harrowing struggle.",
            "perception_type": "action_target_general",
            "actor_id": "{event.payload.actorId}",
            "target_id": "{event.payload.primaryId}",
            "contextual_data": {
              "recipientIds": ["{event.payload.primaryId}"]
            }
          }
        },
        {
          "type": "SET_VARIABLE",
          "parameters": {
              "variable_name": "logMessage",
              "value": "{context.actorName} extracts the corruption out of {context.targetName} swiftly using {context.anchorName}. Light returns to {context.targetName}'s eyes."
            }
          },
          { "macro": "core:logSuccessOutcomeAndEndTurn" }
        ]
      }
    },
    {
      "type": "IF",
      "comment": "Handle SUCCESS outcome",
      "parameters": {
        "condition": {
          "==": [
            { "var": "context.extractionResult.outcome" },
            "SUCCESS"
          ]
        },
        "then_actions": [
          {
            "type": "REMOVE_COMPONENT",
            "parameters": {
              "entity_ref": "primary",
              "component_type": "warding:corrupted"
            }
          },
          { "type": "REGENERATE_DESCRIPTION", "parameters": { "entity_ref": "primary" } },
        {
          "type": "DISPATCH_PERCEPTIBLE_EVENT",
          "parameters": {
            "location_id": "{context.actorPosition.locationId}",
            "description_text": "After a struggle, {context.actorName} extracts the corruption out of {context.targetName} using {context.anchorName}.",
            "perception_type": "action_target_general",
            "actor_id": "{event.payload.actorId}",
            "target_id": "{event.payload.primaryId}",
            "contextual_data": {
              "excludedActorIds": ["{event.payload.primaryId}"]
            }
          }
        },
        {
          "type": "DISPATCH_PERCEPTIBLE_EVENT",
          "parameters": {
            "location_id": "{context.actorPosition.locationId}",
            "description_text": "{context.actorName} uses {context.anchorName} against me, and my insides feel on fire as something claws at my flesh trying to avoid getting sucked out. I suffer through the struggle, but in the end, the darkness is gone, and I feel cleaner.",
            "perception_type": "action_target_general",
            "actor_id": "{event.payload.actorId}",
            "target_id": "{event.payload.primaryId}",
            "contextual_data": {
              "recipientIds": ["{event.payload.primaryId}"]
            }
          }
        },
        {
          "type": "SET_VARIABLE",
          "parameters": {
              "variable_name": "logMessage",
              "value": "After a struggle, {context.actorName} extracts the corruption out of {context.targetName} using {context.anchorName}."
            }
          },
          { "macro": "core:logSuccessOutcomeAndEndTurn" }
        ]
      }
    },
    {
      "type": "IF",
      "comment": "Handle FAILURE outcome",
      "parameters": {
        "condition": {
          "==": [
            { "var": "context.extractionResult.outcome" },
            "FAILURE"
          ]
        },
        "then_actions": [
        {
          "type": "DISPATCH_PERCEPTIBLE_EVENT",
          "parameters": {
            "location_id": "{context.actorPosition.locationId}",
            "description_text": "Despite a struggle, {context.actorName} fails to extract the corruption out of {context.targetName} using {context.anchorName}. Darkness lingers in {context.targetName}'s eyes.",
            "perception_type": "action_target_general",
            "actor_id": "{event.payload.actorId}",
            "target_id": "{event.payload.primaryId}",
            "contextual_data": {
              "excludedActorIds": ["{event.payload.primaryId}"]
            }
          }
        },
        {
          "type": "DISPATCH_PERCEPTIBLE_EVENT",
          "parameters": {
            "location_id": "{context.actorPosition.locationId}",
            "description_text": "{context.actorName} uses {context.anchorName} against me, and suddenly my insides feel on fire as something claws at my flesh trying to avoid getting sucked out. I suffer through a harrowing struggle. The darkness refuses to leave my body.",
            "perception_type": "action_target_general",
            "actor_id": "{event.payload.actorId}",
            "target_id": "{event.payload.primaryId}",
            "contextual_data": {
              "recipientIds": ["{event.payload.primaryId}"]
            }
          }
        },
        {
          "type": "SET_VARIABLE",
          "parameters": {
              "variable_name": "logMessage",
              "value": "Despite a struggle, {context.actorName} fails to extract the corruption out of {context.targetName} using {context.anchorName}. Darkness lingers in {context.targetName}'s eyes."
            }
          },
          { "macro": "core:logFailureOutcomeAndEndTurn" }
        ]
      }
    },
    {
      "type": "IF",
      "comment": "Handle FUMBLE outcome",
      "parameters": {
        "condition": {
          "==": [
            { "var": "context.extractionResult.outcome" },
            "FUMBLE"
          ]
        },
        "then_actions": [
          {
            "type": "UNWIELD_ITEM",
            "parameters": {
              "actorEntity": "{event.payload.actorId}",
              "itemEntity": "{event.payload.secondaryId}"
            }
          },
          {
            "type": "DROP_ITEM_AT_LOCATION",
            "parameters": {
              "actorEntity": "{event.payload.actorId}",
              "itemEntity": "{event.payload.secondaryId}",
              "locationId": "{context.actorPosition.locationId}"
            }
          },
          { "type": "REGENERATE_DESCRIPTION", "parameters": { "entity_ref": "{event.payload.actorId}" } },
        {
          "type": "DISPATCH_PERCEPTIBLE_EVENT",
          "parameters": {
            "location_id": "{context.actorPosition.locationId}",
            "description_text": "{context.actorName} attempts to extract the corruption out of {context.targetName} using {context.anchorName}, but during the struggle, the {context.anchorName} slips from {context.actorName}'s hands.",
            "perception_type": "action_target_general",
            "actor_id": "{event.payload.actorId}",
            "target_id": "{event.payload.primaryId}",
            "contextual_data": {
              "excludedActorIds": ["{event.payload.primaryId}"]
            }
          }
        },
        {
          "type": "DISPATCH_PERCEPTIBLE_EVENT",
          "parameters": {
            "location_id": "{context.actorPosition.locationId}",
            "description_text": "{context.actorName} uses {context.anchorName} against me, and suddenly my insides feel on fire as something claws at my flesh trying to avoid getting sucked out. I suffer through a harrowing struggle. With a spasm, the darkness, still anchored inside me, sends an echo that makes {context.anchorName} slip out of {context.actorName}'s hands.",
            "perception_type": "action_target_general",
            "actor_id": "{event.payload.actorId}",
            "target_id": "{event.payload.primaryId}",
            "contextual_data": {
              "recipientIds": ["{event.payload.primaryId}"]
            }
          }
        },
        {
          "type": "SET_VARIABLE",
          "parameters": {
              "variable_name": "logMessage",
              "value": "{context.actorName} attempts to extract the corruption out of {context.targetName} using {context.anchorName}, but during the struggle, the {context.anchorName} slips from {context.actorName}'s hands."
            }
          },
          { "macro": "core:logFailureOutcomeAndEndTurn" }
        ]
      }
    }
  ]
}
