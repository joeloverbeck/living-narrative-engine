{
  "$schema": "schema://living-narrative-engine/rule.schema.json",
  "rule_id": "handle_extract_spiritual_corruption",
  "event_type": "core:attempt_action",
  "condition": {
    "condition_ref": "warding:event-is-action-extract-spiritual-corruption"
  },
  "actions": [
    {
      "type": "GET_NAME",
      "parameters": {
        "entity_ref": "actor",
        "result_variable": "actorName"
      }
    },
    {
      "type": "GET_NAME",
      "parameters": {
        "entity_ref": "primary",
        "result_variable": "targetName"
      }
    },
    {
      "type": "GET_NAME",
      "parameters": {
        "entity_ref": "secondary",
        "result_variable": "anchorName"
      }
    },
    {
      "type": "QUERY_COMPONENT",
      "parameters": {
        "entity_ref": "actor",
        "component_type": "core:position",
        "result_variable": "actorPosition"
      }
    },
    {
      "type": "RESOLVE_OUTCOME",
      "comment": "Opposed contest using warding_skill vs target resolve_skill",
      "parameters": {
        "actor_skill_component": "skills:warding_skill",
        "target_skill_component": "skills:resolve_skill",
        "actor_skill_default": 10,
        "target_skill_default": 0,
        "formula": "ratio",
        "result_variable": "extractionResult",
        "target_role": "primary"
      }
    },
    {
      "type": "SET_VARIABLE",
      "comment": "Shared context for macros and perception",
      "parameters": {
        "variable_name": "locationId",
        "value": "{context.actorPosition.locationId}"
      }
    },
    {
      "type": "SET_VARIABLE",
      "parameters": {
        "variable_name": "perceptionType",
        "value": "physical.target_action"
      }
    },
    {
      "type": "SET_VARIABLE",
      "parameters": {
        "variable_name": "targetId",
        "value": "{event.payload.primaryId}"
      }
    },
    {
      "type": "IF",
      "comment": "Handle CRITICAL_SUCCESS outcome",
      "parameters": {
        "condition": {
          "==": [
            {
              "var": "context.extractionResult.outcome"
            },
            "CRITICAL_SUCCESS"
          ]
        },
        "then_actions": [
          {
            "type": "REMOVE_COMPONENT",
            "parameters": {
              "entity_ref": "primary",
              "component_type": "warding:corrupted"
            }
          },
          {
            "type": "REGENERATE_DESCRIPTION",
            "parameters": {
              "entity_ref": "primary"
            }
          },
          {
            "type": "DISPATCH_PERCEPTIBLE_EVENT",
            "parameters": {
              "location_id": "{context.actorPosition.locationId}",
              "description_text": "{context.actorName} extracts the corruption out of {context.targetName} swiftly using {context.anchorName}. Light returns to {context.targetName}'s eyes.",
              "actor_description": "I swiftly extract the corruption from {context.targetName} using {context.anchorName}. The darkness flees as light returns to their eyes.",
              "target_description": "{context.actorName} uses {context.anchorName} against me. I feel a burning sensation as something dark rushes out. Then it ends, and I feel completely cleansed.",
              "perception_type": "magic.spell",
              "actor_id": "{event.payload.actorId}",
              "target_id": "{event.payload.primaryId}",
              "alternate_descriptions": {
                "auditory": "I hear a struggle and unnatural screeches nearby as dark energy is expelled."
              }
            }
          },
          {
            "type": "SET_VARIABLE",
            "parameters": {
              "variable_name": "logMessage",
              "value": "{context.actorName} extracts the corruption out of {context.targetName} swiftly using {context.anchorName}. Light returns to {context.targetName}'s eyes."
            }
          },
          {
            "macro": "core:logSuccessOutcomeAndEndTurn"
          }
        ]
      }
    },
    {
      "type": "IF",
      "comment": "Handle SUCCESS outcome",
      "parameters": {
        "condition": {
          "==": [
            {
              "var": "context.extractionResult.outcome"
            },
            "SUCCESS"
          ]
        },
        "then_actions": [
          {
            "type": "REMOVE_COMPONENT",
            "parameters": {
              "entity_ref": "primary",
              "component_type": "warding:corrupted"
            }
          },
          {
            "type": "REGENERATE_DESCRIPTION",
            "parameters": {
              "entity_ref": "primary"
            }
          },
          {
            "type": "DISPATCH_PERCEPTIBLE_EVENT",
            "parameters": {
              "location_id": "{context.actorPosition.locationId}",
              "description_text": "After a struggle, {context.actorName} extracts the corruption out of {context.targetName} using {context.anchorName}.",
              "actor_description": "After a struggle, I manage to draw out the corruption from {context.targetName} using {context.anchorName}.",
              "target_description": "{context.actorName} uses {context.anchorName} against me. My insides feel on fire as something claws inside trying to resist. I suffer through the struggle, but the darkness is finally gone.",
              "perception_type": "magic.spell",
              "actor_id": "{event.payload.actorId}",
              "target_id": "{event.payload.primaryId}",
              "alternate_descriptions": {
                "auditory": "I hear a prolonged struggle and unnatural screeches nearby."
              }
            }
          },
          {
            "type": "SET_VARIABLE",
            "parameters": {
              "variable_name": "logMessage",
              "value": "After a struggle, {context.actorName} extracts the corruption out of {context.targetName} using {context.anchorName}."
            }
          },
          {
            "macro": "core:logSuccessOutcomeAndEndTurn"
          }
        ]
      }
    },
    {
      "type": "IF",
      "comment": "Handle FAILURE outcome",
      "parameters": {
        "condition": {
          "==": [
            {
              "var": "context.extractionResult.outcome"
            },
            "FAILURE"
          ]
        },
        "then_actions": [
          {
            "type": "DISPATCH_PERCEPTIBLE_EVENT",
            "parameters": {
              "location_id": "{context.actorPosition.locationId}",
              "description_text": "Despite a struggle, {context.actorName} fails to extract the corruption out of {context.targetName} using {context.anchorName}. Darkness lingers in {context.targetName}'s eyes.",
              "actor_description": "I try to extract the corruption from {context.targetName} using {context.anchorName}, but despite the struggle, the darkness resists my efforts.",
              "target_description": "{context.actorName} uses {context.anchorName} against me. My insides feel on fire as something claws at my flesh. I suffer through a harrowing struggle, but the darkness refuses to leave.",
              "perception_type": "magic.spell",
              "actor_id": "{event.payload.actorId}",
              "target_id": "{event.payload.primaryId}",
              "alternate_descriptions": {
                "auditory": "I hear a struggle and unnatural screeches nearby, but they don't fade."
              }
            }
          },
          {
            "type": "SET_VARIABLE",
            "parameters": {
              "variable_name": "logMessage",
              "value": "Despite a struggle, {context.actorName} fails to extract the corruption out of {context.targetName} using {context.anchorName}. Darkness lingers in {context.targetName}'s eyes."
            }
          },
          {
            "macro": "core:logFailureOutcomeAndEndTurn"
          }
        ]
      }
    },
    {
      "type": "IF",
      "comment": "Handle FUMBLE outcome",
      "parameters": {
        "condition": {
          "==": [
            {
              "var": "context.extractionResult.outcome"
            },
            "FUMBLE"
          ]
        },
        "then_actions": [
          {
            "type": "UNWIELD_ITEM",
            "parameters": {
              "actorEntity": "{event.payload.actorId}",
              "itemEntity": "{event.payload.secondaryId}"
            }
          },
          {
            "type": "DROP_ITEM_AT_LOCATION",
            "parameters": {
              "actorEntity": "{event.payload.actorId}",
              "itemEntity": "{event.payload.secondaryId}",
              "locationId": "{context.actorPosition.locationId}"
            }
          },
          {
            "type": "REGENERATE_DESCRIPTION",
            "parameters": {
              "entity_ref": "{event.payload.actorId}"
            }
          },
          {
            "type": "DISPATCH_PERCEPTIBLE_EVENT",
            "parameters": {
              "location_id": "{context.actorPosition.locationId}",
              "description_text": "{context.actorName} attempts to extract the corruption out of {context.targetName} using {context.anchorName}, but during the struggle, the {context.anchorName} slips from {context.actorName}'s hands.",
              "actor_description": "I attempt to extract the corruption from {context.targetName} using {context.anchorName}, but during the struggle, the {context.anchorName} slips from my hands.",
              "target_description": "{context.actorName} uses {context.anchorName} against me. My insides feel on fire as something claws inside. With a spasm, the darkness sends a shock that makes {context.anchorName} slip from {context.actorName}'s hands.",
              "perception_type": "magic.spell",
              "actor_id": "{event.payload.actorId}",
              "target_id": "{event.payload.primaryId}",
              "alternate_descriptions": {
                "auditory": "I hear a struggle, then something clattering to the ground."
              }
            }
          },
          {
            "type": "SET_VARIABLE",
            "parameters": {
              "variable_name": "logMessage",
              "value": "{context.actorName} attempts to extract the corruption out of {context.targetName} using {context.anchorName}, but during the struggle, the {context.anchorName} slips from {context.actorName}'s hands."
            }
          },
          {
            "macro": "core:logFailureOutcomeAndEndTurn"
          }
        ]
      }
    }
  ]
}
