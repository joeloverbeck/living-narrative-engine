{
  "$schema": "schema://living-narrative-engine/rule.schema.json",
  "rule_id": "handle_punch_target",
  "event_type": "core:attempt_action",
  "condition": { "condition_ref": "striking:event-is-action-punch-target" },
  "actions": [
    {
      "type": "GET_NAME",
      "parameters": { "entity_ref": "actor", "result_variable": "actorName" }
    },
    {
      "type": "GET_NAME",
      "parameters": {
        "entity_ref": "secondary",
        "result_variable": "targetName"
      }
    },
    {
      "type": "GET_NAME",
      "parameters": { "entity_ref": "primary", "result_variable": "weaponName" }
    },
    {
      "type": "QUERY_COMPONENT",
      "parameters": {
        "entity_ref": "actor",
        "component_type": "core:position",
        "result_variable": "actorPosition"
      }
    },
    {
      "type": "QUERY_COMPONENT",
      "parameters": {
        "entity_ref": "primary",
        "component_type": "damage-types:damage_capabilities",
        "result_variable": "weaponDamage"
      }
    },
    {
      "type": "RESOLVE_OUTCOME",
      "parameters": {
        "actor_skill_component": "skills:melee_skill",
        "target_skill_component": "skills:defense_skill",
        "actor_skill_default": 10,
        "target_skill_default": 0,
        "formula": "ratio",
        "result_variable": "attackResult",
        "target_role": "secondary"
      }
    },
    {
      "type": "SET_VARIABLE",
      "comment": "Set common variables needed by the end-turn macros",
      "parameters": {
        "variable_name": "locationId",
        "value": "{context.actorPosition.locationId}"
      }
    },
    {
      "type": "SET_VARIABLE",
      "parameters": {
        "variable_name": "perceptionType",
        "value": "physical.target_action"
      }
    },
    {
      "type": "SET_VARIABLE",
      "parameters": {
        "variable_name": "targetId",
        "value": "{event.payload.secondaryId}"
      }
    },
    {
      "type": "SET_VARIABLE",
      "comment": "Punch-specific: exclude non-blunt damage types (arms only do blunt damage)",
      "parameters": {
        "variable_name": "excludeDamageTypes",
        "value": ["slashing", "piercing"]
      }
    },
    {
      "type": "IF",
      "comment": "Handle CRITICAL_SUCCESS outcome - flat structure (1 of 4)",
      "parameters": {
        "condition": {
          "==": [{ "var": "context.attackResult.outcome" }, "CRITICAL_SUCCESS"]
        },
        "then_actions": [
          {
            "type": "DISPATCH_PERCEPTIBLE_EVENT",
            "parameters": {
              "location_id": "{context.actorPosition.locationId}",
              "description_text": "{context.actorName} lands a devastating punch with their {context.weaponName} on {context.targetName}!",
              "actor_description": "I land a devastating punch with my {context.weaponName} on {context.targetName}!",
              "target_description": "{context.actorName} lands a devastating punch on me with their {context.weaponName}!",
              "perception_type": "combat.attack",
              "actor_id": "{event.payload.actorId}",
              "target_id": "{event.payload.secondaryId}",
              "alternate_descriptions": {
                "auditory": "I hear the heavy thud of a powerful blow landing nearby.",
                "tactile": "I feel the vibration of a hard impact nearby."
              }
            }
          },
          {
            "type": "SET_VARIABLE",
            "comment": "Set logMessage BEFORE damage loop so success message displays first",
            "parameters": {
              "variable_name": "logMessage",
              "value": "{context.actorName} lands a devastating punch with their {context.weaponName} on {context.targetName}!"
            }
          },
          {
            "type": "DISPATCH_EVENT",
            "comment": "Display success message BEFORE damage details (which are deferred via queueMicrotask)",
            "parameters": {
              "eventType": "core:display_successful_action_result",
              "payload": {
                "message": "{context.logMessage}"
              }
            }
          },
          {
            "type": "FOR_EACH",
            "parameters": {
              "collection": "context.weaponDamage.entries",
              "item_variable": "dmgEntry",
              "actions": [
                {
                  "type": "APPLY_DAMAGE",
                  "parameters": {
                    "entity_ref": "secondary",
                    "damage_entry": {
                      "var": "context.dmgEntry"
                    },
                    "damage_multiplier": 1.5,
                    "exclude_damage_types": {
                      "var": "context.excludeDamageTypes"
                    }
                  }
                },
                {
                  "type": "REGENERATE_DESCRIPTION",
                  "parameters": {
                    "entity_ref": "secondary"
                  }
                }
              ]
            }
          },
          {
            "type": "IF",
            "comment": "Add attacked_by component if missing",
            "parameters": {
              "condition": {
                "!": { "var": "entity.secondary.components.attack-states:attacked_by" }
              },
              "then_actions": [
                {
                  "type": "ADD_COMPONENT",
                  "parameters": {
                    "entity_ref": "secondary",
                    "component_type": "attack-states:attacked_by",
                    "value": { "attackers": [] }
                  }
                }
              ]
            }
          },
          {
            "type": "MODIFY_ARRAY_FIELD",
            "comment": "Mark target as attacked by actor",
            "parameters": {
              "entity_ref": "secondary",
              "component_type": "attack-states:attacked_by",
              "field": "attackers",
              "mode": "push_unique",
              "value": "{event.payload.actorId}"
            }
          },
          {
            "macro": "core:endTurnOnly"
          }
        ]
      }
    },
    {
      "type": "IF",
      "comment": "Handle SUCCESS outcome - flat structure (2 of 4)",
      "parameters": {
        "condition": {
          "==": [{ "var": "context.attackResult.outcome" }, "SUCCESS"]
        },
        "then_actions": [
          {
            "type": "DISPATCH_PERCEPTIBLE_EVENT",
            "parameters": {
              "location_id": "{context.actorPosition.locationId}",
              "description_text": "{context.actorName} punches {context.targetName} with their {context.weaponName}, landing a solid blow.",
              "actor_description": "I punch {context.targetName} with my {context.weaponName}, landing a solid blow.",
              "target_description": "{context.actorName} punches me with their {context.weaponName}, landing a solid blow.",
              "perception_type": "combat.attack",
              "actor_id": "{event.payload.actorId}",
              "target_id": "{event.payload.secondaryId}",
              "alternate_descriptions": {
                "auditory": "I hear the sound of flesh striking flesh nearby.",
                "tactile": "I feel the impact of a blow nearby."
              }
            }
          },
          {
            "type": "SET_VARIABLE",
            "comment": "Set logMessage BEFORE damage loop so success message displays first",
            "parameters": {
              "variable_name": "logMessage",
              "value": "{context.actorName} punches {context.targetName} with their {context.weaponName}, landing a solid blow."
            }
          },
          {
            "type": "DISPATCH_EVENT",
            "comment": "Display success message BEFORE damage details (which are deferred via queueMicrotask)",
            "parameters": {
              "eventType": "core:display_successful_action_result",
              "payload": {
                "message": "{context.logMessage}"
              }
            }
          },
          {
            "type": "FOR_EACH",
            "parameters": {
              "collection": "context.weaponDamage.entries",
              "item_variable": "dmgEntry",
              "actions": [
                {
                  "type": "APPLY_DAMAGE",
                  "parameters": {
                    "entity_ref": "secondary",
                    "damage_entry": {
                      "var": "context.dmgEntry"
                    },
                    "exclude_damage_types": {
                      "var": "context.excludeDamageTypes"
                    }
                  }
                },
                {
                  "type": "REGENERATE_DESCRIPTION",
                  "parameters": {
                    "entity_ref": "secondary"
                  }
                }
              ]
            }
          },
          {
            "type": "IF",
            "comment": "Add attacked_by component if missing",
            "parameters": {
              "condition": {
                "!": { "var": "entity.secondary.components.attack-states:attacked_by" }
              },
              "then_actions": [
                {
                  "type": "ADD_COMPONENT",
                  "parameters": {
                    "entity_ref": "secondary",
                    "component_type": "attack-states:attacked_by",
                    "value": { "attackers": [] }
                  }
                }
              ]
            }
          },
          {
            "type": "MODIFY_ARRAY_FIELD",
            "comment": "Mark target as attacked by actor",
            "parameters": {
              "entity_ref": "secondary",
              "component_type": "attack-states:attacked_by",
              "field": "attackers",
              "mode": "push_unique",
              "value": "{event.payload.actorId}"
            }
          },
          {
            "macro": "core:endTurnOnly"
          }
        ]
      }
    },
    {
      "type": "IF",
      "comment": "Handle FAILURE outcome - flat structure (3 of 4)",
      "parameters": {
        "condition": {
          "==": [{ "var": "context.attackResult.outcome" }, "FAILURE"]
        },
        "then_actions": [
          {
            "type": "DISPATCH_PERCEPTIBLE_EVENT",
            "parameters": {
              "location_id": "{context.actorPosition.locationId}",
              "description_text": "{context.actorName} throws a punch at {context.targetName} with their {context.weaponName}, but the blow fails to connect.",
              "actor_description": "I throw a punch at {context.targetName} with my {context.weaponName}, but fail to connect.",
              "target_description": "{context.actorName} throws a punch at me with their {context.weaponName}, but fails to connect.",
              "perception_type": "combat.attack",
              "actor_id": "{event.payload.actorId}",
              "target_id": "{event.payload.secondaryId}",
              "alternate_descriptions": {
                "auditory": "I hear someone swing and miss nearby."
              }
            }
          },
          {
            "type": "SET_VARIABLE",
            "parameters": {
              "variable_name": "logMessage",
              "value": "{context.actorName} throws a punch at {context.targetName} with their {context.weaponName}, but the blow fails to connect."
            }
          },
          {
            "type": "IF",
            "comment": "Add attacked_by component if missing",
            "parameters": {
              "condition": {
                "!": { "var": "entity.secondary.components.attack-states:attacked_by" }
              },
              "then_actions": [
                {
                  "type": "ADD_COMPONENT",
                  "parameters": {
                    "entity_ref": "secondary",
                    "component_type": "attack-states:attacked_by",
                    "value": { "attackers": [] }
                  }
                }
              ]
            }
          },
          {
            "type": "MODIFY_ARRAY_FIELD",
            "comment": "Mark target as attacked by actor",
            "parameters": {
              "entity_ref": "secondary",
              "component_type": "attack-states:attacked_by",
              "field": "attackers",
              "mode": "push_unique",
              "value": "{event.payload.actorId}"
            }
          },
          {
            "macro": "core:logFailureOutcomeAndEndTurn"
          }
        ]
      }
    },
    {
      "type": "IF",
      "comment": "Handle FUMBLE outcome - flat structure (4 of 4)",
      "parameters": {
        "condition": {
          "==": [{ "var": "context.attackResult.outcome" }, "FUMBLE"]
        },
        "then_actions": [
          {
            "type": "ADD_COMPONENT",
            "comment": "Fumble: actor falls from overextending",
            "parameters": {
              "entity_ref": "actor",
              "component_type": "recovery-states:fallen",
              "value": {}
            }
          },
          {
            "type": "DISPATCH_PERCEPTIBLE_EVENT",
            "parameters": {
              "location_id": "{context.actorPosition.locationId}",
              "description_text": "{context.actorName} swings wildly at {context.targetName} but completely misses, losing balance and falling to the ground!",
              "actor_description": "I swing wildly at {context.targetName} but completely miss, losing my balance and falling to the ground!",
              "target_description": "{context.actorName} swings wildly at me but completely misses, losing their balance and falling to the ground!",
              "perception_type": "combat.violence",
              "actor_id": "{event.payload.actorId}",
              "target_id": "{event.payload.secondaryId}",
              "alternate_descriptions": {
                "auditory": "I hear someone stumble and fall heavily nearby.",
                "tactile": "I feel the thud of someone hitting the ground nearby."
              }
            }
          },
          {
            "type": "SET_VARIABLE",
            "parameters": {
              "variable_name": "logMessage",
              "value": "{context.actorName} swings wildly at {context.targetName} but completely misses, losing balance and falling to the ground!"
            }
          },
          {
            "type": "IF",
            "comment": "Add attacked_by component if missing",
            "parameters": {
              "condition": {
                "!": { "var": "entity.secondary.components.attack-states:attacked_by" }
              },
              "then_actions": [
                {
                  "type": "ADD_COMPONENT",
                  "parameters": {
                    "entity_ref": "secondary",
                    "component_type": "attack-states:attacked_by",
                    "value": { "attackers": [] }
                  }
                }
              ]
            }
          },
          {
            "type": "MODIFY_ARRAY_FIELD",
            "comment": "Mark target as attacked by actor",
            "parameters": {
              "entity_ref": "secondary",
              "component_type": "attack-states:attacked_by",
              "field": "attackers",
              "mode": "push_unique",
              "value": "{event.payload.actorId}"
            }
          },
          {
            "macro": "core:logFailureOutcomeAndEndTurn"
          }
        ]
      }
    }
  ]
}
