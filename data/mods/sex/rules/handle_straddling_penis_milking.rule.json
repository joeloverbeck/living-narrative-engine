{
  "$schema": "schema://living-narrative-engine/rule.schema.json",
  "rule_id": "handle_straddling_penis_milking",
  "comment": "Handles the 'sex:straddling_penis_milking' action by establishing mutual vaginal penetration state and broadcasting the sensual milking narration.",
  "event_type": "core:attempt_action",
  "condition": {
    "condition_ref": "sex:event-is-action-straddling-penis-milking"
  },
  "actions": [
    {
      "type": "GET_NAME",
      "parameters": {
        "entity_ref": "actor",
        "result_variable": "actorName"
      }
    },
    {
      "type": "GET_NAME",
      "parameters": {
        "entity_ref": "primary",
        "result_variable": "primaryName"
      }
    },
    {
      "type": "QUERY_COMPONENT",
      "parameters": {
        "entity_ref": "actor",
        "component_type": "core:position",
        "result_variable": "actorPosition"
      }
    },
    {
      "type": "QUERY_COMPONENT",
      "parameters": {
        "entity_ref": "actor",
        "component_type": "sex:being_fucked_vaginally",
        "result_variable": "existingBeingFucked"
      }
    },
    {
      "type": "QUERY_COMPONENT",
      "parameters": {
        "entity_ref": "primary",
        "component_type": "sex:fucking_vaginally",
        "result_variable": "existingFucking"
      }
    },
    {
      "type": "IF",
      "parameters": {
        "condition": {
          "not": {
            "var": "context.existingBeingFucked"
          }
        },
        "then_actions": [
          {
            "type": "ADD_COMPONENT",
            "parameters": {
              "entity_ref": "actor",
              "component_type": "sex:being_fucked_vaginally",
              "value": {
                "actorId": "{event.payload.primaryId}"
              }
            }
          }
        ],
        "else_actions": [
          {
            "type": "IF",
            "parameters": {
              "condition": {
                "==": [
                  { "var": "context.existingBeingFucked.actorId" },
                  "{event.payload.primaryId}"
                ]
              },
              "then_actions": [],
              "else_actions": [
                {
                  "type": "REMOVE_COMPONENT",
                  "parameters": {
                    "entity_ref": "actor",
                    "component_type": "sex:being_fucked_vaginally"
                  }
                },
                {
                  "type": "ADD_COMPONENT",
                  "parameters": {
                    "entity_ref": "actor",
                    "component_type": "sex:being_fucked_vaginally",
                    "value": {
                      "actorId": "{event.payload.primaryId}"
                    }
                  }
                }
              ]
            }
          }
        ]
      }
    },
    {
      "type": "IF",
      "parameters": {
        "condition": {
          "not": {
            "var": "context.existingFucking"
          }
        },
        "then_actions": [
          {
            "type": "ADD_COMPONENT",
            "parameters": {
              "entity_ref": "primary",
              "component_type": "sex:fucking_vaginally",
              "value": {
                "targetId": "{event.payload.actorId}"
              }
            }
          }
        ],
        "else_actions": [
          {
            "type": "IF",
            "parameters": {
              "condition": {
                "==": [
                  { "var": "context.existingFucking.targetId" },
                  "{event.payload.actorId}"
                ]
              },
              "then_actions": [],
              "else_actions": [
                {
                  "type": "REMOVE_COMPONENT",
                  "parameters": {
                    "entity_ref": "primary",
                    "component_type": "sex:fucking_vaginally"
                  }
                },
                {
                  "type": "ADD_COMPONENT",
                  "parameters": {
                    "entity_ref": "primary",
                    "component_type": "sex:fucking_vaginally",
                    "value": {
                      "targetId": "{event.payload.actorId}"
                    }
                  }
                }
              ]
            }
          }
        ]
      }
    },
    {
      "type": "SET_VARIABLE",
      "parameters": {
        "variable_name": "logMessage",
        "value": "{context.actorName} rocks {context.primaryName}'s penis slowly with her vagina, feeling each inch and vein of the penis."
      }
    },
    {
      "type": "SET_VARIABLE",
      "parameters": {
        "variable_name": "perceptionType",
        "value": "action_target_general"
      }
    },
    {
      "type": "SET_VARIABLE",
      "parameters": {
        "variable_name": "actorId",
        "value": "{event.payload.actorId}"
      }
    },
    {
      "type": "SET_VARIABLE",
      "parameters": {
        "variable_name": "locationId",
        "value": "{context.actorPosition.locationId}"
      }
    },
    {
      "type": "SET_VARIABLE",
      "parameters": {
        "variable_name": "targetId",
        "value": "{event.payload.primaryId}"
      }
    },
    {
      "macro": "core:logSuccessAndEndTurn"
    }
  ]
}
