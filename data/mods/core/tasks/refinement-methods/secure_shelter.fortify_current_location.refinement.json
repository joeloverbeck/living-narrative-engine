{
  "$schema": "schema://living-narrative-engine/refinement-method.schema.json",
  "id": "core:secure_shelter.fortify_current_location",
  "taskId": "core:secure_shelter",
  "description": "Fortify the actor's current location to provide shelter protection. This method is used when the actor cannot or should not move to another location but needs shelter. The actor uses available materials to create barriers and protection at their current position.",
  "applicability": {
    "description": "Actor must be at a fortifiable location with materials available",
    "condition": {
      "and": [
        {"has_component": ["task.params.shelter", "core:fortifiable"]},
        {"has_component": ["task.params.shelter", "core:current_location"]},
        {">": [
          {"var": "actor.core:inventory.materials_count"},
          2
        ]}
      ]
    }
  },
  "steps": [
    {
      "stepType": "conditional",
      "description": "Check if barricade materials are available nearby",
      "condition": {
        "has_component": ["task.params.shelter", "core:barricade_materials_nearby"]
      },
      "thenSteps": [
        {
          "stepType": "primitive_action",
          "actionId": "crafting:gather_materials",
          "targetBindings": {
            "location": "task.params.shelter"
          },
          "parameters": {
            "materialType": "barricade",
            "quantity": 3
          },
          "description": "Gather additional barricade materials"
        }
      ],
      "onFailure": "skip"
    },
    {
      "stepType": "primitive_action",
      "actionId": "crafting:create_barricade",
      "targetBindings": {
        "location": "task.params.shelter"
      },
      "parameters": {
        "barricadeType": "basic",
        "coverage": "partial"
      },
      "description": "Create protective barricade at current location"
    }
  ],
  "fallbackBehavior": "replan"
}
