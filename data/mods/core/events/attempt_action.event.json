{
  "$schema": "schema://living-narrative-engine/component.schema.json",
  "id": "core:attempt_action",
  "description": "Enhanced event schema for both single and multi-target actions, dispatched when an actor tries to perform an action.",
  "payloadSchema": {
    "description": "Defines the structure of the data payload for the 'core:attempt_action' event with multi-target support.",
    "type": "object",
    "required": ["eventName", "actorId", "actionId", "originalInput"],
    "properties": {
      "eventName": {
        "description": "Confirms the type of event.",
        "const": "core:attempt_action"
      },
      "actorId": {
        "$ref": "schema://living-narrative-engine/common.schema.json#/definitions/namespacedId",
        "description": "The ID of the entity attempting the action."
      },
      "actionId": {
        "$ref": "schema://living-narrative-engine/common.schema.json#/definitions/namespacedId",
        "description": "The ID of the action being attempted."
      },
      "targets": {
        "type": "object",
        "description": "Multi-target structure with named targets for complex actions",
        "additionalProperties": {
          "oneOf": [
            {
              "type": "string",
              "minLength": 1,
              "description": "Direct target entity ID (for namespaced entities)"
            },
            {
              "type": "object",
              "description": "Rich target object (for runtime-created entities with metadata)",
              "properties": {
                "entityId": {
                  "type": "string",
                  "minLength": 1,
                  "description": "The target entity ID"
                },
                "placeholder": {
                  "type": "string",
                  "minLength": 1,
                  "description": "Target placeholder name"
                },
                "description": {
                  "type": "string",
                  "description": "Human-readable target description"
                },
                "resolvedFromContext": {
                  "type": "boolean",
                  "description": "Whether this target was resolved from context"
                },
                "contextSource": {
                  "type": "string",
                  "description": "Source of context resolution if applicable"
                }
              },
              "required": ["entityId"],
              "additionalProperties": false
            }
          ]
        },
        "examples": [
          {
            "primary": "core:character_instance",
            "secondary": "core:item_example"
          },
          {
            "person": "alice_789",
            "clothing": {
              "entityId": "c103dff8-bfec-49f5-adb0-2c889ec5893e",
              "placeholder": "clothing",
              "description": "denim trucker jacket",
              "resolvedFromContext": true,
              "contextSource": "person"
            }
          },
          {
            "item": "knife_345",
            "target": "goblin_678"
          }
        ]
      },
      "targetId": {
        "$ref": "schema://living-narrative-engine/common.schema.json#/definitions/nullableNamespacedId",
        "description": "Primary target for backward compatibility with legacy rules"
      },
      "originalInput": {
        "type": "string",
        "minLength": 1,
        "description": "The exact command or input string entered by the player or generated by AI."
      },
      "timestamp": {
        "type": "number",
        "description": "Event creation timestamp",
        "minimum": 0
      },
      "primaryId": {
        "$ref": "schema://living-narrative-engine/common.schema.json#/definitions/nullableNamespacedId",
        "description": "Primary target entity ID for rule convenience (flattened from targets)"
      },
      "secondaryId": {
        "$ref": "schema://living-narrative-engine/common.schema.json#/definitions/nullableNamespacedId",
        "description": "Secondary target entity ID for rule convenience (flattened from targets)"
      },
      "tertiaryId": {
        "$ref": "schema://living-narrative-engine/common.schema.json#/definitions/nullableNamespacedId",
        "description": "Tertiary target entity ID for rule convenience (flattened from targets)"
      },
      "resolvedTargetCount": {
        "type": "number",
        "description": "Number of targets that were resolved for this action",
        "minimum": 0
      },
      "hasContextDependencies": {
        "type": "boolean",
        "description": "Whether the action targets have context dependencies"
      },
      "trace": {
        "type": "object",
        "description": "Optional trace object for execution debugging and performance monitoring"
      }
    },
    "additionalProperties": false,
    "anyOf": [
      {
        "description": "Legacy format: requires targetId",
        "required": ["targetId"]
      },
      {
        "description": "Multi-target format: requires targets and targetId as primary",
        "required": ["targets", "targetId"],
        "properties": {
          "targets": {
            "minProperties": 1
          },
          "targetId": {
            "type": "string",
            "minLength": 1
          }
        }
      }
    ]
  }
}
