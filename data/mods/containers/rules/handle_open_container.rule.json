{
  "$schema": "schema://living-narrative-engine/rule.schema.json",
  "rule_id": "handle_open_container",
  "comment": "Handles open_container action with key validation and perception logging",
  "event_type": "core:attempt_action",
  "condition": {
    "condition_ref": "containers:event-is-action-open-container"
  },
  "actions": [
    {
      "type": "OPEN_CONTAINER",
      "comment": "Attempt to open container with key validation",
      "parameters": {
        "actorEntity": "{event.payload.actorId}",
        "containerEntity": "{event.payload.targetId}",
        "result_variable": "openResult"
      }
    },
    {
      "type": "IF",
      "comment": "Branch based on open result",
      "parameters": {
        "condition": {
          "==": [
            {
              "var": "context.openResult.success"
            },
            false
          ]
        },
        "then_actions": [
          {
            "type": "IF",
            "comment": "Check if failure was due to missing key",
            "parameters": {
              "condition": {
                "==": [
                  {
                    "var": "context.openResult.error"
                  },
                  "missing_key"
                ]
              },
              "then_actions": [
                {
                  "type": "QUERY_COMPONENT",
                  "comment": "Get actor position for logging",
                  "parameters": {
                    "entity_ref": "actor",
                    "component_type": "core:position",
                    "result_variable": "actorPosition"
                  }
                },
                {
                  "type": "GET_NAME",
                  "parameters": {
                    "entity_ref": "actor",
                    "result_variable": "actorName"
                  }
                },
                {
                  "type": "GET_NAME",
                  "parameters": {
                    "entity_ref": "target",
                    "result_variable": "containerName"
                  }
                },
                {
                  "type": "GET_TIMESTAMP",
                  "comment": "Get current timestamp",
                  "parameters": {
                    "result_variable": "currentTimestamp"
                  }
                },
                {
                  "type": "DISPATCH_PERCEPTIBLE_EVENT",
                  "comment": "Log failed opening for observers",
                  "parameters": {
                    "location_id": "{context.actorPosition.locationId}",
                    "description_text": "{context.actorName} tries to open {context.containerName}, but it's locked.",
                    "perception_type": "error.action_failed",
                    "actor_id": "{event.payload.actorId}",
                    "target_id": "{event.payload.targetId}",
                    "contextual_data": {
                      "reason": "missing_key"
                    }
                  }
                },
                {
                  "type": "END_TURN",
                  "comment": "End turn after failed opening due to missing key",
                  "parameters": {
                    "entityId": "{event.payload.actorId}",
                    "success": false,
                    "error": {
                      "message": "Container is locked and you don't have the key"
                    }
                  }
                }
              ],
              "else_actions": [
                {
                  "type": "END_TURN",
                  "comment": "End turn after other failure (already open, not openable, etc.)",
                  "parameters": {
                    "entityId": "{event.payload.actorId}",
                    "success": false,
                    "error": {
                      "message": "{context.openResult.error}"
                    }
                  }
                }
              ]
            }
          }
        ],
        "else_actions": [
          {
            "type": "QUERY_COMPONENT",
            "comment": "Get actor position for successful logging",
            "parameters": {
              "entity_ref": "actor",
              "component_type": "core:position",
              "result_variable": "actorPosition"
            }
          },
          {
            "type": "GET_NAME",
            "parameters": {
              "entity_ref": "actor",
              "result_variable": "actorName"
            }
          },
          {
            "type": "GET_NAME",
            "parameters": {
              "entity_ref": "target",
              "result_variable": "containerName"
            }
          },
          {
            "type": "GET_TIMESTAMP",
            "comment": "Get current timestamp",
            "parameters": {
              "result_variable": "currentTimestamp"
            }
          },
          {
            "type": "SET_VARIABLE",
            "comment": "Prepare success message for macro",
            "parameters": {
              "variable_name": "logMessage",
              "value": "{context.actorName} opens {context.containerName}."
            }
          },
          {
            "type": "SET_VARIABLE",
            "comment": "Set perception type for macro",
            "parameters": {
              "variable_name": "perceptionType",
              "value": "container.open"
            }
          },
          {
            "type": "SET_VARIABLE",
            "comment": "Set location for macro",
            "parameters": {
              "variable_name": "locationId",
              "value": "{context.actorPosition.locationId}"
            }
          },
          {
            "type": "SET_VARIABLE",
            "comment": "Set target for macro",
            "parameters": {
              "variable_name": "targetId",
              "value": "{event.payload.targetId}"
            }
          },
          {
            "comment": "Display success message and end turn",
            "macro": "core:logSuccessAndEndTurn"
          }
        ]
      }
    }
  ]
}
