{
  "$schema": "schema://living-narrative-engine/rule.schema.json",
  "rule_id": "handle_sit_down",
  "comment": "Handles positioning:sit_down action",
  "event_type": "core:attempt_action",
  "condition": {
    "condition_ref": "positioning:event-is-action-sit-down"
  },
  "actions": [
    {
      "type": "QUERY_COMPONENT",
      "comment": "Get current furniture spots array",
      "parameters": {
        "entity_id": "{event.payload.targetId}",
        "component_type": "positioning:allows_sitting",
        "result_variable": "furnitureData"
      }
    },
    {
      "type": "SET_VARIABLE",
      "comment": "Initialize spot index to -1 (not found)",
      "parameters": {
        "variable_name": "spotIndex",
        "value": -1
      }
    },
    {
      "type": "SET_VARIABLE",
      "comment": "Check if first spot is empty",
      "parameters": {
        "variable_name": "spot0Empty",
        "value": { "==": [{ "var": "context.furnitureData.spots.0" }, null] }
      }
    },
    {
      "type": "IF",
      "parameters": {
        "condition": { "var": "context.spot0Empty" },
        "then_actions": [
          {
            "type": "SET_VARIABLE",
            "parameters": {
              "variable_name": "spotIndex",
              "value": 0
            }
          },
          {
            "type": "MODIFY_COMPONENT",
            "comment": "Set actor ID at spots.0",
            "parameters": {
              "entity_ref": "target",
              "component_type": "positioning:allows_sitting",
              "field": "spots.0",
              "mode": "set",
              "value": "{event.payload.actorId}"
            }
          }
        ],
        "else_actions": [
          {
            "type": "SET_VARIABLE",
            "comment": "Check if second spot exists and is empty",
            "parameters": {
              "variable_name": "spot1Empty",
              "value": {
                "==": [{ "var": "context.furnitureData.spots.1" }, null]
              }
            }
          },
          {
            "type": "IF",
            "parameters": {
              "condition": { "var": "context.spot1Empty" },
              "then_actions": [
                {
                  "type": "SET_VARIABLE",
                  "parameters": {
                    "variable_name": "spotIndex",
                    "value": 1
                  }
                },
                {
                  "type": "MODIFY_COMPONENT",
                  "comment": "Set actor ID at spots.1",
                  "parameters": {
                    "entity_ref": "target",
                    "component_type": "positioning:allows_sitting",
                    "field": "spots.1",
                    "mode": "set",
                    "value": "{event.payload.actorId}"
                  }
                }
              ],
              "else_actions": [
                {
                  "type": "SET_VARIABLE",
                  "comment": "Check if third spot exists and is empty",
                  "parameters": {
                    "variable_name": "spot2Empty",
                    "value": {
                      "==": [{ "var": "context.furnitureData.spots.2" }, null]
                    }
                  }
                },
                {
                  "type": "IF",
                  "parameters": {
                    "condition": { "var": "context.spot2Empty" },
                    "then_actions": [
                      {
                        "type": "SET_VARIABLE",
                        "parameters": {
                          "variable_name": "spotIndex",
                          "value": 2
                        }
                      },
                      {
                        "type": "MODIFY_COMPONENT",
                        "comment": "Set actor ID at spots.2",
                        "parameters": {
                          "entity_ref": "target",
                          "component_type": "positioning:allows_sitting",
                          "field": "spots.2",
                          "mode": "set",
                          "value": "{event.payload.actorId}"
                        }
                      }
                    ],
                    "else_actions": [
                      {
                        "type": "SET_VARIABLE",
                        "comment": "No empty spots found in first 3 positions",
                        "parameters": {
                          "variable_name": "spotIndex",
                          "value": -1
                        }
                      }
                    ]
                  }
                }
              ]
            }
          }
        ]
      }
    },
    {
      "type": "IF",
      "comment": "Only proceed if we found an empty spot",
      "parameters": {
        "condition": { ">=": [{ "var": "context.spotIndex" }, 0] },
        "then_actions": [
          {
            "type": "ADD_COMPONENT",
            "comment": "Add sitting_on component to actor",
            "parameters": {
              "entity_ref": "actor",
              "component_type": "positioning:sitting_on",
              "value": {
                "furniture_id": "{event.payload.targetId}",
                "spot_index": "{context.spotIndex}"
              }
            }
          },
          {
            "type": "LOCK_MOVEMENT",
            "comment": "Lock movement while sitting",
            "parameters": {
              "actor_id": "{event.payload.actorId}"
            }
          },
          {
            "type": "GET_NAME",
            "parameters": { "entity_ref": "actor", "result_variable": "actorName" }
          },
          {
            "type": "GET_NAME",
            "parameters": { "entity_ref": "target", "result_variable": "targetName" }
          },
          {
            "type": "QUERY_COMPONENT",
            "parameters": {
              "entity_ref": "actor",
              "component_type": "core:position",
              "result_variable": "actorPosition"
            }
          },
          {
            "type": "SET_VARIABLE",
            "parameters": {
              "variable_name": "logMessage",
              "value": "{context.actorName} sits down on {context.targetName}."
            }
          },
          {
            "type": "SET_VARIABLE",
            "parameters": {
              "variable_name": "perceptionType",
              "value": "action_target_general"
            }
          },
          {
            "type": "SET_VARIABLE",
            "parameters": {
              "variable_name": "locationId",
              "value": "{context.actorPosition.locationId}"
            }
          },
          {
            "type": "SET_VARIABLE",
            "parameters": {
              "variable_name": "targetId",
              "value": "{event.payload.targetId}"
            }
          },
          {
            "macro": "core:logSuccessAndEndTurn"
          }
        ]
      }
    }
  ]
}