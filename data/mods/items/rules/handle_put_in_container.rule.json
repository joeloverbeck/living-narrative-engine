{
  "$schema": "schema://living-narrative-engine/rule.schema.json",
  "rule_id": "handle_put_in_container",
  "comment": "Handles put_in_container action with capacity validation",
  "event_type": "core:attempt_action",
  "condition": {
    "condition_ref": "items:event-is-action-put-in-container"
  },
  "actions": [
    {
      "type": "VALIDATE_CONTAINER_CAPACITY",
      "comment": "Check if container has capacity for the item",
      "parameters": {
        "containerEntity": "{event.payload.targetId}",
        "itemEntity": "{event.payload.secondaryId}",
        "result_variable": "capacityCheck"
      }
    },
    {
      "type": "IF",
      "comment": "Branch based on capacity validation",
      "parameters": {
        "condition": {
          "==": [
            { "var": "context.capacityCheck.valid" },
            false
          ]
        },
        "then_actions": [
        {
          "type": "QUERY_COMPONENT",
          "comment": "Get actor position for logging",
          "parameters": {
            "entity_ref": "actor",
            "component_type": "core:position",
            "result_variable": "actorPosition"
          }
        },
        {
          "type": "GET_NAME",
          "comment": "Get actor name",
          "parameters": {
            "entity_ref": "actor",
            "result_variable": "actorName"
          }
        },
        {
          "type": "GET_NAME",
          "comment": "Get container name",
          "parameters": {
            "entity_ref": "target",
            "result_variable": "containerName"
          }
        },
        {
          "type": "GET_NAME",
          "comment": "Get item name",
          "parameters": {
            "entity_ref": "{event.payload.secondaryId}",
            "result_variable": "itemName"
          }
        },
        {
          "type": "SET_VARIABLE",
          "comment": "Prepare failure message",
          "parameters": {
            "variable_name": "logMessage",
            "value": "{context.actorName} tried to put {context.itemName} in {context.containerName}, but it won't fit."
          }
        },
        {
          "type": "DISPATCH_PERCEPTIBLE_EVENT",
          "comment": "Log failed put",
          "parameters": {
            "location_id": "{context.actorPosition.locationId}",
            "description_text": "{context.logMessage}",
            "perception_type": "put_in_container_failed",
            "actor_id": "{event.payload.actorId}",
            "target_id": "{event.payload.targetId}",
            "involved_entities": ["{event.payload.secondaryId}"],
            "contextual_data": {
              "reason": "{context.capacityCheck.reason}"
            }
          }
        },
        {
          "type": "END_TURN",
          "comment": "End turn after failed put",
          "parameters": {
            "entityId": "{event.payload.actorId}",
            "success": false
          }
        }
      ],
      "else_actions": [
        {
          "type": "PUT_IN_CONTAINER",
          "comment": "Move item from inventory to container",
          "parameters": {
            "actorEntity": "{event.payload.actorId}",
            "containerEntity": "{event.payload.targetId}",
            "itemEntity": "{event.payload.secondaryId}",
            "result_variable": "putResult"
          }
        },
        {
          "type": "QUERY_COMPONENT",
          "comment": "Get actor position for logging",
          "parameters": {
            "entity_ref": "actor",
            "component_type": "core:position",
            "result_variable": "actorPosition"
          }
        },
        {
          "type": "GET_NAME",
          "comment": "Get actor name",
          "parameters": {
            "entity_ref": "actor",
            "result_variable": "actorName"
          }
        },
        {
          "type": "GET_NAME",
          "comment": "Get container name",
          "parameters": {
            "entity_ref": "target",
            "result_variable": "containerName"
          }
        },
        {
          "type": "GET_NAME",
          "comment": "Get item name",
          "parameters": {
            "entity_ref": "{event.payload.secondaryId}",
            "result_variable": "itemName"
          }
        },
        {
          "type": "SET_VARIABLE",
          "comment": "Prepare success message",
          "parameters": {
            "variable_name": "logMessage",
            "value": "{context.actorName} put {context.itemName} in {context.containerName}."
          }
        },
        {
          "type": "DISPATCH_PERCEPTIBLE_EVENT",
          "comment": "Log successful put",
          "parameters": {
            "location_id": "{context.actorPosition.locationId}",
            "description_text": "{context.logMessage}",
            "perception_type": "item_put_in_container",
            "actor_id": "{event.payload.actorId}",
            "target_id": "{event.payload.targetId}",
            "involved_entities": ["{event.payload.secondaryId}"]
          }
        },
        {
          "type": "END_TURN",
          "comment": "End actor's turn after putting item",
          "parameters": {
            "entityId": "{event.payload.actorId}",
            "success": true
          }
        }
      ]
      }
    }
  ]
}
