{
  "$schema": "schema://living-narrative-engine/rule.schema.json",
  "rule_id": "handle_push_yourself_to_your_feet",
  "comment": "Handles the 'recovery:push_yourself_to_your_feet' action. Removes fallen component, dispatches descriptive text and ends the turn.",
  "event_type": "core:attempt_action",
  "condition": { "condition_ref": "recovery:event-is-action-push-yourself-to-your-feet" },
  "actions": [
    {
      "type": "QUERY_COMPONENT",
      "parameters": {
        "entity_ref": "actor",
        "component_type": "positioning:fallen",
        "result_variable": "fallenState"
      }
    },
    {
      "type": "IF",
      "parameters": {
        "condition": {
          "!!": [{ "var": "context.fallenState" }]
        },
        "then_actions": [
          {
            "type": "GET_NAME",
            "parameters": { "entity_ref": "actor", "result_variable": "actorName" }
          },
          {
            "type": "QUERY_COMPONENT",
            "parameters": {
              "entity_ref": "actor",
              "component_type": "core:position",
              "result_variable": "actorPosition"
            }
          },
          {
            "type": "REMOVE_COMPONENT",
            "parameters": {
              "entity_ref": "actor",
              "component_type": "positioning:fallen"
            }
          },
          {
            "type": "REGENERATE_DESCRIPTION",
            "parameters": { "entity_ref": "actor" }
          },
          {
            "type": "UNLOCK_MOVEMENT",
            "comment": "Unlock movement after standing up",
            "parameters": {
              "actor_id": "{event.payload.actorId}"
            }
          },
          {
            "type": "SET_VARIABLE",
            "parameters": {
              "variable_name": "logMessage",
              "value": "{context.actorName} pushes themselves back to their feet."
            }
          },
          {
            "type": "SET_VARIABLE",
            "parameters": {
              "variable_name": "perceptionType",
              "value": "action_self_general"
            }
          },
          {
            "type": "SET_VARIABLE",
            "parameters": {
              "variable_name": "locationId",
              "value": "{context.actorPosition.locationId}"
            }
          },
          {
            "type": "SET_VARIABLE",
            "parameters": {
              "variable_name": "targetId",
              "value": null
            }
          },
          { "macro": "core:logSuccessAndEndTurn" }
        ],
        "else_actions": [
          {
            "type": "SET_VARIABLE",
            "parameters": {
              "variable_name": "logMessage",
              "value": "You must be fallen to push yourself to your feet."
            }
          },
          {
             "type": "SET_VARIABLE",
             "parameters": {
               "variable_name": "perceptionType",
               "value": "error"
             }
          },
          { "macro": "core:logFailureAndEndTurn" }
        ]
      }
    }
  ]
}
