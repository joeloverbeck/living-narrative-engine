<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Debug Connection Test</title>
  </head>
  <body>
    <h1>Debug Connection Test</h1>
    <div id="status">Testing...</div>
    <div id="logs"></div>

    <script>
      const statusDiv = document.getElementById('status');
      const logsDiv = document.getElementById('logs');

      function addLog(message, type = 'info') {
        const logEntry = document.createElement('div');
        logEntry.style.padding = '5px';
        logEntry.style.margin = '2px 0';
        logEntry.style.border = '1px solid #ccc';
        logEntry.style.backgroundColor =
          type === 'error' ? '#ffeeee' : '#eeffee';
        logEntry.textContent = `${new Date().toISOString()}: ${message}`;
        logsDiv.appendChild(logEntry);
        console.log(message);
      }

      async function testDirectConnection() {
        addLog('Testing direct connection to debug endpoint...');

        try {
          const response = await fetch('http://127.0.0.1:3001/api/debug-log', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              logs: [
                {
                  level: 'debug',
                  message: 'Test connection from browser',
                  timestamp: new Date().toISOString(),
                  sessionId: 'test-session-123',
                },
              ],
            }),
          });

          if (response.ok) {
            const result = await response.json();
            addLog(`SUCCESS: Server responded with ${JSON.stringify(result)}`);
            statusDiv.textContent = 'Connection successful!';
            statusDiv.style.color = 'green';
          } else {
            addLog(
              `ERROR: Server responded with status ${response.status}: ${response.statusText}`,
              'error'
            );
            statusDiv.textContent = `Connection failed: HTTP ${response.status}`;
            statusDiv.style.color = 'red';
          }
        } catch (error) {
          addLog(`ERROR: ${error.message}`, 'error');
          statusDiv.textContent = `Connection failed: ${error.message}`;
          statusDiv.style.color = 'red';
        }
      }

      async function testCORSPreflight() {
        addLog('Testing CORS preflight...');

        try {
          const response = await fetch('http://127.0.0.1:3001/api/debug-log', {
            method: 'OPTIONS',
            headers: {
              Origin: window.location.origin,
              'Access-Control-Request-Method': 'POST',
              'Access-Control-Request-Headers': 'Content-Type',
            },
          });

          addLog(
            `CORS preflight response: ${response.status} ${response.statusText}`
          );

          // Log all response headers
          for (const [key, value] of response.headers.entries()) {
            addLog(`Header: ${key}: ${value}`);
          }
        } catch (error) {
          addLog(`CORS preflight error: ${error.message}`, 'error');
        }
      }

      // Run tests when page loads
      window.addEventListener('load', async () => {
        addLog(`Page loaded from origin: ${window.location.origin}`);
        addLog(`Testing connection from hostname: ${window.location.hostname}`);

        await testCORSPreflight();
        await new Promise((resolve) => setTimeout(resolve, 1000)); // Wait 1 second
        await testDirectConnection();
      });
    </script>
  </body>
</html>
