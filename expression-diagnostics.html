<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Expression Diagnostics - Living Narrative Engine</title>
  <link rel="stylesheet" href="css/style.css" />
  <link rel="stylesheet" href="css/expression-diagnostics.css" />
</head>
<body>
  <div class="diagnostics-container">
    <header class="diagnostics-header">
      <h1>Expression Diagnostics</h1>
      <button id="back-button" class="menu-button">Back to Menu</button>
    </header>

    <main class="diagnostics-main">
      <!-- Expression Selection Panel -->
      <section class="panel expression-selection-panel">
        <h2>Expression Selection</h2>
        <div class="form-group">
          <label id="expression-select-label" for="expression-select">Select Expression:</label>
          <div id="expression-select-container" class="status-select-container">
            <!-- StatusSelectDropdown renders here -->
          </div>
        </div>
        <p id="expression-description" class="expression-description"></p>
      </section>

      <!-- Problematic Expressions Panel -->
      <section class="panel problematic-expressions-panel">
        <h2>Problematic Expressions</h2>
        <p class="panel-description">Expressions with problematic diagnostic statuses. Click to select.</p>
        <div id="problematic-pills-container" class="pills-container">
          <p class="placeholder-text">Loading...</p>
        </div>
      </section>

      <!-- Status Summary - Centered Prominent Display -->
      <section class="panel status-summary-centered">
        <div id="status-indicator" class="status-indicator status-unknown">
          <span class="status-circle-large status-circle status-unknown"></span>
          <span class="status-label">Not Analyzed</span>
        </div>
        <p id="status-message" class="status-message"></p>
      </section>

      <!-- Results Area -->
      <div class="results-area">
        <!-- Static Analysis Details -->
        <section class="panel static-analysis-panel">
          <h2>Static Analysis Results</h2>
          <div class="section-action-button">
            <button id="run-static-btn" class="action-button" disabled>
              Run Static Analysis
            </button>
          </div>
          <div id="static-results" class="results-content">
            <p class="placeholder-text">Run static analysis to see results.</p>
          </div>
        </section>

        <!-- Gate Conflicts Table -->
        <section class="panel gate-conflicts-panel" id="gate-conflicts-section" hidden>
          <h2>Gate Conflicts</h2>
          <table id="gate-conflicts-table" class="results-table">
            <thead>
              <tr>
                <th>Axis</th>
                <th>Required</th>
                <th>Conflicting Prototypes</th>
                <th>Gates</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </section>

        <!-- Unreachable Thresholds Table -->
        <section class="panel thresholds-panel" id="thresholds-section" hidden>
          <h2>Unreachable Thresholds</h2>
          <table id="thresholds-table" class="results-table">
            <thead>
              <tr>
                <th>Prototype</th>
                <th>Type</th>
                <th>Required</th>
                <th>Max Possible</th>
                <th>Gap</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </section>

        <!-- Path-Sensitive Analysis Section -->
        <section id="path-sensitive-results" class="panel path-sensitive-panel" hidden>
          <div class="panel-header-row">
            <h2>Path-Sensitive Analysis</h2>
            <label class="toggle-switch" id="show-all-branches-toggle">
              <input type="checkbox" id="show-all-branches">
              <span class="toggle-slider"></span>
              <span class="toggle-label">Show All</span>
            </label>
          </div>

          <div id="path-sensitive-summary" class="summary-card">
            <span id="ps-status-indicator" class="status-indicator"></span>
            <span id="ps-summary-message" class="summary-message"></span>
          </div>

          <div id="volume-indicator" class="volume-indicator hidden">
            <span id="volume-emoji" class="volume-emoji"></span>
            <span id="volume-label" class="volume-label">Feasibility Volume:</span>
            <span id="volume-value" class="volume-value"></span>
            <span id="volume-description" class="volume-description"></span>
          </div>

          <div id="branch-overview" class="branch-overview">
            <span id="branch-count-display">Analyzing <span id="branch-count">0</span> branches...</span>
            <span id="reachable-count-display"><span id="reachable-count">0</span> fully reachable</span>
          </div>

          <div id="branch-cards-container" class="branch-cards-container">
            <!-- Branch cards will be inserted here dynamically -->
          </div>

          <details id="knife-edge-summary" class="knife-edge-summary" hidden>
            <summary>
              <span class="ke-icon">⚠️</span>
              <span id="ke-count">0</span> Knife-Edge Constraint(s) Detected
            </summary>
            <table id="knife-edge-table" class="results-table">
              <thead>
                <tr>
                  <th>Axis</th>
                  <th>Interval</th>
                  <th>Width</th>
                  <th>Contributing Prototypes</th>
                  <th>Branch</th>
                </tr>
              </thead>
              <tbody id="knife-edge-tbody">
                <!-- Knife-edge rows inserted dynamically -->
              </tbody>
            </table>
          </details>
        </section>

        <!-- Monte Carlo Section -->
        <section class="panel mc-panel" id="monte-carlo-section">
          <h2>Monte Carlo Simulation</h2>
          <div class="mc-controls">
            <div class="control-group">
              <label for="sample-count">Sample Count:</label>
              <select id="sample-count" class="form-select">
                <option value="1000">1,000 (Fast)</option>
                <option value="10000" selected>10,000 (Standard)</option>
                <option value="100000">100,000 (Precise)</option>
              </select>
            </div>
            <div class="control-group">
              <label for="distribution">Distribution:</label>
              <select id="distribution" class="form-select">
                <option value="uniform" selected>Uniform</option>
                <option value="gaussian">Gaussian</option>
              </select>
            </div>
            <button id="run-mc-btn" class="action-button" disabled>Run Simulation</button>
          </div>
          <div id="mc-results" class="mc-results" hidden>
            <div class="trigger-rate-display">
              <div class="rarity-indicator" id="mc-rarity-indicator">
                <span class="rarity-circle status-circle"></span>
                <span class="rarity-label"></span>
              </div>
              <div class="rate-details">
                <span class="trigger-rate" id="mc-trigger-rate">--</span>
                <span class="confidence-interval" id="mc-confidence-interval">(-- - --)</span>
              </div>
            </div>
            <p class="mc-summary" id="mc-summary"></p>
            <h3>Top Blockers</h3>
            <table id="blockers-table" class="results-table blockers-table">
              <thead>
                <tr>
                  <th class="toggle-header"></th>
                  <th>Rank</th>
                  <th>Clause</th>
                  <th>Failure Rate</th>
                  <th>Avg. Violation</th>
                  <th>Severity</th>
                </tr>
              </thead>
              <tbody id="blockers-tbody"></tbody>
            </table>
          </div>
        </section>

        <!-- Witness State Section -->
        <section class="panel witness-panel" id="witness-section">
          <h2>Witness State Finder</h2>
          <p class="section-description">
            Find a concrete state that would trigger this expression.
          </p>
          <div class="section-action-button">
            <button id="find-witness-btn" class="action-button" disabled>
              Find Witness State
            </button>
          </div>

          <div class="witness-controls">
            <span id="witness-status" class="status-text"></span>
          </div>

          <div id="witness-results" class="results-container" hidden>
            <div class="witness-header">
              <span id="witness-result-label" class="result-label"></span>
              <button id="copy-witness-btn" class="btn btn-secondary btn-small">
                Copy to Clipboard
              </button>
            </div>

            <div class="witness-content">
              <h3>Mood Axes</h3>
              <div id="mood-display" class="axis-grid">
                <!-- Populated dynamically -->
              </div>

              <h3>Sexual State</h3>
              <div id="sexual-display" class="axis-grid">
                <!-- Populated dynamically -->
              </div>

              <h3>Affect Traits</h3>
              <div id="traits-display" class="axis-grid">
                <!-- Populated dynamically -->
              </div>
            </div>

            <div id="witness-json" class="json-display">
              <pre id="witness-json-content"></pre>
            </div>

            <div id="violated-clauses" class="violated-clauses" hidden>
              <h4>Violated Clauses (Nearest Miss)</h4>
              <ul id="violated-clauses-list"></ul>
            </div>

            <div id="fitness-display" class="fitness-display">
              <label>Fitness Score:</label>
              <div class="fitness-bar">
                <div id="fitness-fill" class="fitness-fill"></div>
              </div>
              <span id="fitness-value">--</span>
            </div>
          </div>
        </section>
      </div>
    </main>
  </div>

  <!-- Template for branch cards (hidden, cloned via JS) -->
  <template id="branch-card-template">
    <div class="branch-card" data-status="pending">
      <div class="branch-card-header">
        <span class="branch-status-icon"></span>
        <span class="branch-title"></span>
      </div>
      <div class="branch-card-content">
        <div class="branch-prototypes">
          <strong>Required prototypes:</strong>
          <span class="prototype-list"></span>
        </div>
        <div class="branch-thresholds" hidden>
          <table class="threshold-table">
            <thead>
              <tr>
                <th>Prototype</th>
                <th>Required</th>
                <th>Max Possible</th>
                <th>Gap</th>
              </tr>
            </thead>
            <tbody class="threshold-tbody">
            </tbody>
          </table>
        </div>
        <div class="branch-knife-edges" hidden>
          <div class="ke-warning">
            <span class="ke-icon">⚠️</span>
            <span class="ke-message"></span>
          </div>
        </div>
      </div>
    </div>
  </template>

  <script src="expression-diagnostics.js"></script>
</body>
</html>
