<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Expression Diagnostics - Living Narrative Engine</title>
  <link rel="stylesheet" href="css/style.css" />
  <link rel="stylesheet" href="css/expression-diagnostics.css" />
</head>
<body>
  <div class="diagnostics-container">
    <header class="diagnostics-header">
      <h1>Expression Diagnostics</h1>
      <button id="back-button" class="menu-button">Back to Menu</button>
    </header>

    <main class="diagnostics-main">
      <!-- Expression Selection Panel -->
      <section class="panel expression-selection-panel">
        <h2>Expression Selection</h2>
        <div class="form-group">
          <label id="expression-select-label" for="expression-select">Select Expression:</label>
          <div id="expression-select-container" class="status-select-container">
            <!-- StatusSelectDropdown renders here -->
          </div>
        </div>
        <p id="expression-description" class="expression-description"></p>
      </section>

      <!-- Problematic Expressions Panel -->
      <section class="panel problematic-expressions-panel">
        <h2>Problematic Expressions</h2>
        <p class="panel-description">Expressions with problematic diagnostic statuses. Click to select.</p>
        <div id="problematic-pills-container" class="pills-container">
          <p class="placeholder-text">Loading...</p>
        </div>
      </section>

      <!-- Status Summary - Centered Prominent Display -->
      <section class="panel status-summary-centered">
        <div id="status-indicator" class="status-indicator status-unknown">
          <span class="status-circle-large status-circle status-unknown"></span>
          <span class="status-label">Not Analyzed</span>
        </div>
        <p id="status-message" class="status-message"></p>
      </section>

      <!-- Results Area -->
      <div class="results-area">
        <!-- Static Analysis Details -->
        <section class="panel static-analysis-panel">
          <h2>Static Analysis Results</h2>
          <div class="section-action-button">
            <button id="run-static-btn" class="action-button" disabled>
              Run Static Analysis
            </button>
          </div>
          <div id="static-results" class="results-content">
            <p class="placeholder-text">Run static analysis to see results.</p>
          </div>
        </section>

        <!-- Gate Conflicts Table -->
        <section class="panel gate-conflicts-panel" id="gate-conflicts-section" hidden>
          <h2>Gate Conflicts</h2>
          <table id="gate-conflicts-table" class="results-table">
            <thead>
              <tr>
                <th>Axis</th>
                <th>Required</th>
                <th>Conflicting Prototypes</th>
                <th>Gates</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </section>

        <!-- Unreachable Thresholds Table -->
        <section class="panel thresholds-panel" id="thresholds-section" hidden>
          <h2>Unreachable Thresholds</h2>
          <table id="thresholds-table" class="results-table">
            <thead>
              <tr>
                <th>Prototype</th>
                <th>Type</th>
                <th>Required</th>
                <th>Max Possible</th>
                <th>Gap</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </section>

        <!-- Path-Sensitive Analysis Section -->
        <section id="path-sensitive-results" class="panel path-sensitive-panel" hidden>
          <div class="panel-header-row">
            <h2>Path-Sensitive Analysis</h2>
            <label class="toggle-switch" id="show-all-branches-toggle">
              <input type="checkbox" id="show-all-branches">
              <span class="toggle-slider"></span>
              <span class="toggle-label">Show All</span>
            </label>
          </div>

          <div id="path-sensitive-summary" class="summary-card">
            <span id="ps-status-indicator" class="status-indicator"></span>
            <span id="ps-summary-message" class="summary-message"></span>
          </div>

          <div id="volume-indicator" class="volume-indicator hidden">
            <span id="volume-emoji" class="volume-emoji"></span>
            <span id="volume-label" class="volume-label">Feasibility Volume:</span>
            <span id="volume-value" class="volume-value"></span>
            <span id="volume-description" class="volume-description"></span>
          </div>

          <div id="branch-overview" class="branch-overview">
            <span id="branch-count-display">Analyzing <span id="branch-count">0</span> branches...</span>
            <span id="reachable-count-display"><span id="reachable-count">0</span> fully reachable</span>
          </div>

          <div id="branch-cards-container" class="branch-cards-container">
            <!-- Branch cards will be inserted here dynamically -->
          </div>

          <details id="knife-edge-summary" class="knife-edge-summary" hidden>
            <summary>
              <span class="ke-icon">‚ö†Ô∏è</span>
              <span id="ke-count">0</span> Knife-Edge Constraint(s) Detected
            </summary>
            <table id="knife-edge-table" class="results-table">
              <thead>
                <tr>
                  <th>Axis</th>
                  <th>Interval</th>
                  <th>Width</th>
                  <th>Contributing Prototypes</th>
                  <th>Branch</th>
                </tr>
              </thead>
              <tbody id="knife-edge-tbody">
                <!-- Knife-edge rows inserted dynamically -->
              </tbody>
            </table>
          </details>
        </section>

        <!-- Monte Carlo Section -->
        <section class="panel mc-panel" id="monte-carlo-section">
          <h2>Monte Carlo Simulation</h2>
          <div class="mc-controls">
            <div class="control-group">
              <label for="sample-count">Sample Count:</label>
              <select id="sample-count" class="form-select">
                <option value="1000">1,000 (Fast)</option>
                <option value="10000" selected>10,000 (Standard)</option>
                <option value="100000">100,000 (Precise)</option>
              </select>
            </div>
            <div class="control-group">
              <label for="distribution">Distribution:</label>
              <select id="distribution" class="form-select">
                <option value="uniform" selected>Uniform</option>
                <option value="gaussian">Gaussian</option>
              </select>
            </div>
            <button id="run-mc-btn" class="action-button" disabled>Run Simulation</button>
          </div>
          <p class="mc-sampling-note">
            Sampling: prototype-gated (emotions derived from mood axes; not independent).
          </p>
          <div id="mc-results" class="mc-results" hidden>
            <div class="trigger-rate-display">
              <div class="rarity-indicator" id="mc-rarity-indicator">
                <span class="rarity-circle status-circle"></span>
                <span class="rarity-label"></span>
              </div>
              <div class="rate-details">
                <span class="trigger-rate" id="mc-trigger-rate">--</span>
                <span class="confidence-interval" id="mc-confidence-interval">(-- - --)</span>
              </div>
            </div>
            <p class="mc-summary" id="mc-summary"></p>
            <div id="mc-population-summary" class="mc-population-summary" hidden>
              <h3>Population Summary</h3>
              <div class="population-summary-grid">
                <div class="population-summary-item">
                  <div class="population-summary-label">Total samples</div>
                  <div class="population-summary-value">
                    <span id="mc-population-sample-count">--</span>
                    <span class="population-summary-muted">(in-regime <span id="mc-population-in-regime-sample-count">--</span>)</span>
                  </div>
                </div>
                <div class="population-summary-item">
                  <div class="population-summary-label">Stored contexts</div>
                  <div class="population-summary-value">
                    <span id="mc-population-stored-count">--</span>
                    <span class="population-summary-muted">(in-regime <span id="mc-population-stored-in-regime-count">--</span>)</span>
                  </div>
                </div>
                <div class="population-summary-item">
                  <div class="population-summary-label">Stored context limit</div>
                  <div class="population-summary-value">
                    <span id="mc-population-stored-limit">--</span>
                  </div>
                </div>
              </div>
              <p class="population-summary-note">
                Stored contexts are a capped subset for sensitivity analysis, so counts can differ from full samples.
              </p>
            </div>
            <div id="mc-integrity-warnings" class="mc-integrity-warnings" hidden>
              <h3>Integrity Warnings</h3>
              <p id="mc-integrity-warnings-summary" class="mc-integrity-warnings-summary"></p>
              <ul id="mc-integrity-warnings-list" class="mc-integrity-warnings-list"></ul>
              <p id="mc-integrity-warnings-impact" class="mc-integrity-warnings-impact"></p>
              <div id="mc-integrity-drilldown" class="mc-integrity-drilldown" hidden>
                <h4>Signal Lineage Drill-down</h4>
                <p id="mc-integrity-drilldown-summary" class="mc-integrity-drilldown-summary"></p>
                <div id="mc-integrity-drilldown-content" class="mc-integrity-drilldown-content"></div>
              </div>
            </div>
            <div class="mc-results-actions">
              <button id="generate-report-btn" class="action-button action-button--secondary">
                Generate Report
              </button>
              <span class="mc-report-note">Report includes global vs in-regime (mood-pass) stats.</span>
            </div>
            <div id="mc-sampling-coverage" class="mc-sampling-coverage-container" hidden>
              <h3>
                Sampling Coverage
                <span id="sampling-coverage-metrics-flag" class="integrity-flag" hidden>
                  Unreliable
                </span>
              </h3>
              <p class="sampling-coverage-summary"></p>
              <div class="sampling-coverage-tables"></div>
              <div class="sampling-coverage-conclusions" hidden>
                <h4>Coverage Conclusions</h4>
                <ul class="sampling-coverage-conclusions-list"></ul>
              </div>
            </div>
            <h3>
              Top Blockers
              <span id="mc-gate-metrics-flag" class="integrity-flag" hidden>
                Unreliable
              </span>
            </h3>
            <table id="blockers-table" class="results-table blockers-table">
              <thead>
                <tr>
                  <th class="toggle-header"></th>
                  <th>Rank</th>
                  <th>Choke rank</th>
                <th>Clause</th>
                <th>Fail %</th>
                <th>Sole-Blocker Rate</th>
                <th title="Gate clamp (forced 0) within the mood-regime subset. Denominator: mood-regime samples.">Gate clamp (mood)</th>
                <th title="Pass rate given gates pass within the mood-regime subset. Denominator: gate-pass samples.">Pass | gate (mood)</th>
                <th title="Heuristic classification based on gate clamp and pass | gate rates (mood-regime denominators).">Gate vs threshold</th>
                <th>Recommendation</th>
                <th>Severity</th>
              </tr>
            </thead>
              <tbody id="blockers-tbody"></tbody>
            </table>

            <!-- Recommendations -->
            <div id="mc-recommendations" class="mc-recommendations" hidden>
              <h3>Recommendations</h3>
              <div id="mc-recommendations-warning" class="sensitivity-warning" hidden>
                <span class="warning-icon">‚ö†Ô∏è</span>
                <span class="warning-text"></span>
              </div>
              <div id="mc-recommendations-list" class="mc-recommendations-list">
                <!-- Recommendation cards populated dynamically -->
              </div>
            </div>

            <!-- Ground-Truth Witnesses from Monte Carlo -->
            <div id="mc-witnesses" class="mc-witnesses-container" hidden>
              <h3>Ground-Truth Witnesses</h3>
              <div id="mc-witnesses-list" class="mc-witnesses-list">
                <!-- Witness cards populated dynamically -->
              </div>
            </div>

            <!-- Global Expression Sensitivity -->
            <div id="global-sensitivity" class="global-sensitivity-container" hidden>
              <h3>
                üéØ Global Expression Sensitivity Analysis
                <span id="global-sensitivity-metrics-flag" class="integrity-flag" hidden>
                  Unreliable
                </span>
              </h3>
              <p class="sensitivity-intro">
                Shows how adjusting thresholds affects the <strong>entire expression trigger rate</strong>,
                not just individual clause pass rates.
              </p>
              <p class="population-label" data-population-role="stored-contexts"></p>
              <div id="global-sensitivity-tables" class="sensitivity-tables">
                <!-- Sensitivity tables populated dynamically -->
              </div>
            </div>

            <!-- Conditional Pass Rates Under Mood Regime -->
            <div id="conditional-pass-rates" class="conditional-pass-rates-container" hidden>
              <h3>
                üìä Conditional Pass Rates (Given Mood Constraints)
                <span id="conditional-pass-metrics-flag" class="integrity-flag" hidden>
                  Unreliable
                </span>
              </h3>
              <p class="conditional-intro">
                Shows how often each emotion condition passes when the mood state is already suitable.
                Low rates indicate emotion-specific blockers that persist even in favorable mood regimes.
              </p>
              <p class="population-label" data-population-role="stored-contexts"></p>
              <p class="conditional-regime-note">
                Regime context: in-regime rates reflect only samples where all mood constraints pass.
              </p>
              <div id="conditional-pass-warning" class="sensitivity-warning" hidden>
                <span class="warning-icon">‚ö†Ô∏è</span>
                <span class="warning-text">
                  This analysis treats mood-axis constraints as AND-only. OR-based mood constraints are present, so results are conservative (may be overly strict).
                </span>
              </div>
              <div id="conditional-gate-warning" class="sensitivity-warning" hidden></div>
              <div id="conditional-pass-rates-content" class="conditional-content">
                <!-- Conditional pass rates table populated dynamically -->
              </div>
            </div>

            <!-- Sole-Blocker Decomposition -->
            <div id="last-mile-decomposition" class="last-mile-decomposition-container" hidden>
              <h3>
                üî¨ Sole-Blocker Decomposition
                <span id="last-mile-metrics-flag" class="integrity-flag" hidden>
                  Unreliable
                </span>
              </h3>
              <p class="decomposition-intro">
                For decisive blockers, shows why the emotion value is too low by analyzing
                axis contributions and identifying dominant suppressors.
              </p>
              <p class="population-label" data-population-role="stored-contexts"></p>
              <div id="last-mile-decomposition-content" class="decomposition-content">
                <!-- Decomposition panels populated dynamically -->
              </div>
            </div>

            <!-- Static Analysis Cross-Reference -->
            <div id="static-cross-reference" class="static-cross-reference-container" hidden>
              <h3>
                üîó Static Analysis Cross-Reference
                <span id="static-cross-reference-metrics-flag" class="integrity-flag" hidden>
                  Unreliable
                </span>
              </h3>
              <p class="cross-reference-intro">
                Compares findings from static analysis with Monte Carlo observations.
              </p>
              <div id="static-cross-reference-content" class="cross-reference-content">
                <!-- Cross-reference tables populated dynamically -->
              </div>
              <div id="cross-reference-summary" class="cross-reference-summary"></div>
            </div>

            <!-- Prototype Fit Analysis -->
            <div id="prototype-fit-analysis" class="prototype-fit-analysis-container" hidden>
              <h3>
                üéØ Prototype Fit Analysis
                <span id="prototype-fit-metrics-flag" class="integrity-flag" hidden>
                  Unreliable
                </span>
              </h3>
              <p class="prototype-fit-intro">
                Ranking of emotion prototypes by how well they fit this expression's mood regime.
              </p>
              <p class="population-label" data-population-role="stored-contexts"></p>
              <div id="prototype-fit-warning" class="sensitivity-warning" hidden>
                <span class="warning-icon">‚ö†Ô∏è</span>
                <span class="warning-text">
                  This analysis treats mood-axis constraints as AND-only. OR-based mood constraints are present, so results are conservative (may be overly strict).
                </span>
              </div>
              <table id="prototype-fit-table" class="results-table prototype-fit-table">
                <thead>
                  <tr>
                    <th>Rank</th>
                    <th>Prototype</th>
                    <th>Gate Pass</th>
                    <th>P(I‚â•t)</th>
                    <th>Conflict</th>
                    <th>Composite</th>
                  </tr>
                </thead>
                <tbody id="prototype-fit-tbody"></tbody>
              </table>
              <div id="prototype-fit-details" class="prototype-fit-details">
                <!-- Detailed info for top prototypes populated dynamically -->
              </div>
              <div id="prototype-fit-suggestion" class="prototype-fit-suggestion"></div>
            </div>

            <!-- Implied Prototype from Prerequisites -->
            <div id="implied-prototype" class="implied-prototype-container" hidden>
              <h3>
                üß≠ Implied Prototype from Prerequisites
                <span id="implied-prototype-metrics-flag" class="integrity-flag" hidden>
                  Unreliable
                </span>
              </h3>
              <p class="implied-prototype-intro">
                Analysis of which prototypes best match the expression's constraint pattern.
              </p>
              <p class="population-label" data-population-role="stored-contexts"></p>
              <div id="implied-prototype-warning" class="sensitivity-warning" hidden>
                <span class="warning-icon">‚ö†Ô∏è</span>
                <span class="warning-text">
                  This analysis treats mood-axis constraints as AND-only. OR-based mood constraints are present, so results are conservative (may be overly strict).
                </span>
              </div>
              <div id="target-signature" class="target-signature-section">
                <h4>Target Signature</h4>
                <table id="target-signature-table" class="results-table target-signature-table">
                  <thead>
                    <tr>
                      <th>Axis</th>
                      <th>Direction</th>
                      <th>Importance</th>
                    </tr>
                  </thead>
                  <tbody id="target-signature-tbody"></tbody>
                </table>
              </div>
              <div id="implied-rankings" class="implied-rankings-section">
                <div class="implied-ranking-column">
                  <h4>Top 5 by Similarity</h4>
                  <table class="results-table similarity-ranking-table">
                    <thead>
                      <tr>
                        <th>Rank</th>
                        <th>Prototype</th>
                        <th>Similarity</th>
                        <th>Gate Pass</th>
                        <th>Combined</th>
                      </tr>
                    </thead>
                    <tbody id="similarity-ranking-tbody"></tbody>
                  </table>
                </div>
                <div class="implied-ranking-column">
                  <h4>Top 5 by Gate Pass</h4>
                  <table class="results-table gate-pass-ranking-table">
                    <thead>
                      <tr>
                        <th>Rank</th>
                        <th>Prototype</th>
                        <th>Gate Pass</th>
                        <th>Similarity</th>
                        <th>Combined</th>
                      </tr>
                    </thead>
                    <tbody id="gate-pass-ranking-tbody"></tbody>
                  </table>
                </div>
                <div class="implied-ranking-column">
                  <h4>Top 5 by Combined</h4>
                  <table class="results-table combined-ranking-table">
                    <thead>
                      <tr>
                        <th>Rank</th>
                        <th>Prototype</th>
                        <th>Combined</th>
                        <th>Similarity</th>
                        <th>Gate Pass</th>
                      </tr>
                    </thead>
                    <tbody id="combined-ranking-tbody"></tbody>
                  </table>
                </div>
              </div>
            </div>

            <!-- Prototype Gap Detection -->
            <div id="gap-detection" class="gap-detection-container" hidden>
              <h3>
                üîç Prototype Gap Detection
                <span id="gap-detection-metrics-flag" class="integrity-flag" hidden>
                  Unreliable
                </span>
              </h3>
              <p class="gap-detection-intro">
                Analysis of prototype coverage in "prototype space".
              </p>
              <p class="population-label" data-population-role="stored-contexts"></p>
              <div id="gap-status" class="gap-status-section">
                <!-- Gap status indicator populated dynamically -->
              </div>
              <div id="nearest-prototypes" class="nearest-prototypes-section">
                <h4>k-Nearest Prototypes</h4>
                <table id="nearest-prototypes-table" class="results-table nearest-prototypes-table">
                  <thead>
                    <tr>
                      <th>Rank</th>
                      <th>Prototype</th>
                      <th>Distance</th>
                      <th>Weight Dist</th>
                      <th>Gate Dist</th>
                    </tr>
                  </thead>
                  <tbody id="nearest-prototypes-tbody"></tbody>
                </table>
              </div>
              <div id="suggested-prototype" class="suggested-prototype-section" hidden>
                <h4>üí° Suggested New Prototype</h4>
                <div id="suggested-prototype-content">
                  <!-- Suggested prototype details populated dynamically -->
                </div>
              </div>
            </div>
          </div>
        </section>

      </div>
    </main>
  </div>

  <!-- Template for branch cards (hidden, cloned via JS) -->
  <template id="branch-card-template">
    <div class="branch-card" data-status="pending">
      <div class="branch-card-header">
        <span class="branch-status-icon"></span>
        <span class="branch-title"></span>
      </div>
      <div class="branch-card-content">
        <div class="branch-prototypes">
          <strong>Required prototypes:</strong>
          <span class="prototype-list"></span>
        </div>
        <div class="branch-thresholds" hidden>
          <table class="threshold-table">
            <thead>
              <tr>
                <th>Prototype</th>
                <th>Required</th>
                <th>Max Possible</th>
                <th>Gap</th>
              </tr>
            </thead>
            <tbody class="threshold-tbody">
            </tbody>
          </table>
        </div>
        <div class="branch-knife-edges" hidden>
          <div class="ke-warning">
            <span class="ke-icon">‚ö†Ô∏è</span>
            <span class="ke-message"></span>
          </div>
        </div>
      </div>
    </div>
  </template>

  <!-- Monte Carlo Report Modal -->
  <div id="mc-report-modal" class="modal-overlay" role="dialog" aria-modal="true" aria-labelledby="mc-report-title" style="display: none;">
    <div class="modal-content modal-content--large">
      <div class="modal-header">
        <h2 id="mc-report-title">Monte Carlo Analysis Report</h2>
        <button id="mc-report-close-btn" class="modal-close-btn" aria-label="Close">&times;</button>
      </div>
      <div class="modal-body">
        <pre id="mc-report-content" class="mc-report-content"></pre>
      </div>
      <div class="modal-footer">
        <div id="mc-report-status" class="status-message-area"></div>
        <button id="mc-report-copy-btn" class="btn btn-primary">
          Copy to Clipboard
        </button>
      </div>
    </div>
  </div>

  <script src="expression-diagnostics.js"></script>
</body>
</html>
