# GOADISGUAROB-003 Expand distance guard regression coverage

## Status: Completed

## Reality check

- `testTaskReducesDistance` already escalates simulator exceptions through `INVALID_EFFECT_DEFINITION`; the `'Failed to check distance reduction'` log only fires when an unexpected downstream error (e.g., logger failure) escapes the guard.
- `tests/unit/goap/planner/goapPlanner.heuristicGuards.test.js` covers specific NaN/Infinity cases, but there was no property-style suite proving sanitized heuristics never return `false`, that effect failures always throw, or that immutable states survive the guard.
- `tests/integration/goap/dualFormatGoalPaths.integration.test.js` exercises numeric guard/goal-path lint coupling and never emits `INVALID_EFFECT_DEFINITION`; the regression surface we need is ensuring those runs also keep effect-failure telemetry empty while still dispatching `DISTANCE_GUARD_BLOCKED`.
- GOAPDebugger never asserted that the planner’s distance-guard failures populate the Effect Failure Telemetry section, so telemetry could silently disappear even if the planner records it.

## Updated scope

- Add `tests/unit/goap/planner/goapPlanner.distanceGuard.property.test.js` with pseudo-fuzz coverage that randomizes invalid heuristic outputs, verifies sanitized paths never return `false`, confirms effect-simulator failures throw `INVALID_EFFECT_DEFINITION`, and checks frozen `currentState` payloads stay untouched.
- Extend `tests/unit/goap/planner/goapPlanner.actionApplicability.test.js` with a regression that forces an unexpected logger failure to bubble, ensuring the `'Failed to check distance reduction'` breadcrumb and `false` fallback remain wired.
- Touch `tests/integration/goap/dualFormatGoalPaths.integration.test.js` to assert that the goal-path regression still yields `DISTANCE_GUARD_BLOCKED` events without polluting effect-failure telemetry.
- Introduce `tests/unit/goap/debugger/GOAPDebugger.telemetry.test.js` to prove telemetry emitted by `testTaskReducesDistance` flows through `GoapController` into the GOAPDebugger diagnostic payload.

## Acceptance criteria

- `npm run test:unit -- goapPlanner.distanceGuard.property` proves sanitized heuristics can never mark tasks as non-reducing and that effect failures throw with telemetry.
- `npm run test:unit -- goapPlanner.actionApplicability` covers both the existing invalid-effect path and the defensive `'Failed to check distance reduction'` log path.
- `npm run test:integration -- dualFormatGoalPaths` still emits the guarded failure events while guaranteeing the effect-failure diagnostics remain empty for pure goal-path violations.
- `npm run test:unit -- GOAPDebugger.telemetry` confirms the debugger report embeds planner telemetry from distance-guard failures.

## Outcome

- Added `tests/unit/goap/planner/helpers/createPlannerHarness.js` plus the new `goapPlanner.distanceGuard.property.test.js` suite to lock in heuristic sanitization, effect failure throwing, and state immutability.
- Extended `tests/unit/goap/planner/goapPlanner.actionApplicability.test.js` with a regression that forces the `'Failed to check distance reduction'` catch path.
- Hardened `tests/integration/goap/dualFormatGoalPaths.integration.test.js` by asserting no effect failure telemetry leaks when only distance guards fire.
- Created `tests/unit/goap/debugger/GOAPDebugger.telemetry.test.js` so the debugger’s Effect Failure panel is proven to surface telemetry generated by `testTaskReducesDistance`.
