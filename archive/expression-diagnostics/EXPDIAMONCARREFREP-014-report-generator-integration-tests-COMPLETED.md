# EXPDIAMONCARREFREP-014: Add MonteCarloReportGenerator Prototype Fit Integration Tests

## Summary
Extend the existing Monte Carlo report integration tests to cover prototype fit, implied prototype, and gap detection sections generated by `MonteCarloReportGenerator`.

## Files to Modify

| File | Action | Changes |
|------|--------|---------|
| `tests/integration/expression-diagnostics/monteCarloReport.integration.test.js` | Modify | Add prototype fit test cases |

## Assumptions Reassessment (from report)
- The integration suite already exists and constructs services directly; there is no `buildTestContainer` helper for expression diagnostics.
- Prototype fit analysis in reports is driven by `PrototypeFitRankingService` (not `PrototypeConstraintAnalyzer` alone). The analyzer is only used to extract axis constraints.
- Prototype fit sections require `simulationResult.storedContexts` and `prerequisites` to be provided; otherwise the section is omitted.
- Report section headers are `# Monte Carlo Analysis Report` and `## Executive Summary`, not `# Monte Carlo` / `## Summary`.
- Coverage targets are not enforced for this integration test; focus on validating section presence and content.

## Out of Scope

- **DO NOT** modify any production code
- **DO NOT** modify unit tests for report generator
- **DO NOT** add tests for UI rendering (modal)
- **DO NOT** modify other integration test files

## Acceptance Criteria

### Tests That Must Be Added

#### Prototype Fit Section
1. Test: Report includes prototype fit section when `PrototypeFitRankingService` is provided and stored contexts are available
2. Test: Prototype fit section lists ranked prototypes from a seeded registry

#### Gap Detection Section
1. Test: Report includes gap detection section when prototype analysis runs
2. Test: Gap detection section includes a coverage status header (`Coverage Gap Detected` or `Good Coverage`)

#### Implied Prototype Section
1. Test: Report includes implied prototype section when axis constraints are extracted
2. Test: Implied prototype section renders a target signature table when mood axes constraints are present

#### Markdown Output Validation
1. Test: Report contains the prototype analysis section headers in addition to existing core headers

### Test Coverage Target
- No enforced coverage target for this ticket; validate the newly added sections in integration context.

### Invariants That Must Remain True
1. Tests follow project integration test patterns
2. Tests construct real services (registry + prototype analysis) without adding new DI helpers
3. Report markdown format is stable (no unexpected changes to existing sections)
4. No production code modifications

## Implementation Notes

### Implementation Notes (revised)
- Use `InMemoryDataRegistry` seeded with a minimal `core:emotion_prototypes` lookup.
- Construct real `PrototypeConstraintAnalyzer` and `PrototypeFitRankingService`, then inject them into `MonteCarloReportGenerator`.
- Provide `simulationResult.storedContexts` and mood-axes prerequisites to drive analysis sections.

## Verification Commands
```bash
npm run test:integration -- --testPathPattern="monteCarloReport.integration"
```

## Dependencies
- **Depends on**: EXPDIAMONCARREFREP-010 (ReportOrchestrator)
- **Blocks**: None

## Status
- **Completed**: 2026-01-11

## Outcome
- Added integration coverage for prototype fit, implied prototype, and gap detection sections using seeded in-memory prototype data.
- Deferred the original DI-container-based approach in favor of direct service construction (no helper exists).
- Left production code unchanged and validated section headers/content instead of enforcing a coverage target.
