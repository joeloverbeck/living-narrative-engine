# Physical Condition Narrative Formatting Specification

## Overview

This specification documents improvements to the Physical Condition narrative text generation in the Living Narrative Engine. The Physical Condition panel displays first-person descriptions of a character's injuries, generated by the `InjuryNarrativeFormatterService`.

## Problem Statement

The current narrative output has three formatting issues:

### Issue 1: Dismemberment Sentences Not Grouped

**Current behavior:**
```
My left ass cheek is missing. My right leg is missing. My right arm is missing. My right ear is missing. My vagina is missing. My left breast is missing.
```

**Required behavior:**
```
My left ass cheek, right leg, right arm, right ear, vagina, and left breast are missing.
```

**Requirements:**
- Multiple dismembered parts must be grouped into a single sentence
- Use "is missing" for singular, "are missing" for plural
- Only the first part receives the "My" prefix
- Use Oxford comma for lists of 3+ items

### Issue 2: Redundant "my" in Bleeding Sentences

**Current behavior:**
```
Blood flows steadily from my torso, my left leg, and my upper head.
```

**Required behavior:**
```
Blood flows steadily from my torso, left leg, and upper head.
```

**Requirements:**
- Only the first body part in the list receives the "my" prefix
- Subsequent parts are listed without possessive prefix
- Maintains Oxford comma formatting for 3+ items

### Issue 3: Head Has Incorrect "upper" Orientation

**Current behavior:**
- Head displays as "upper head" in narrative text
- Caused by `"orientation": "upper"` on neck socket in torso entity definitions

**Required behavior:**
- Head displays as just "head" (no orientation)
- Remove orientation from neck socket definitions

**Root cause:**
The neck socket in torso entities specifies `"orientation": "upper"` which propagates to attached head parts. Since humans have only one head, this orientation is semantically incorrect.

## Technical Implementation

### File: `src/anatomy/services/injuryNarrativeFormatterService.js`

#### New Helper Method

```javascript
/**
 * Formats a list with a possessive prefix on the first item only.
 *
 * @param {string[]} items - List of items to format
 * @param {string} possessive - The possessive prefix (e.g., "My", "my")
 * @returns {string} Formatted list (e.g., "My left arm, right leg, and torso")
 * @private
 */
#formatListWithLeadingPossessive(items, possessive) {
  if (items.length === 0) return '';
  if (items.length === 1) return `${possessive} ${items[0]}`;
  if (items.length === 2) return `${possessive} ${items[0]} and ${items[1]}`;

  const allButLast = items.slice(0, -1);
  const lastItem = items[items.length - 1];
  return `${possessive} ${allButLast.join(', ')}, and ${lastItem}`;
}
```

#### Modified `#formatDismembermentFirstPerson()`

```javascript
#formatDismembermentFirstPerson(summary) {
  const dismemberedParts = summary.dismemberedParts || [];
  if (dismemberedParts.length === 0) {
    return [];
  }

  const partNames = dismemberedParts.map((part) =>
    this.#formatPartName(part.partType, part.orientation)
  );

  const formattedList = this.#formatListWithLeadingPossessive(partNames, 'My');
  const verb = dismemberedParts.length === 1 ? 'is' : 'are';

  return [`${formattedList} ${verb} missing.`];
}
```

#### Modified `#formatBleedingEffectsFirstPerson()`

Change the part name mapping from:
```javascript
const partNames = parts.map(
  (p) => `my ${this.#formatPartName(p.partType, p.orientation)}`
);
const combined = this.#formatListWithOxfordComma(partNames);
```

To:
```javascript
const partNames = parts.map((p) =>
  this.#formatPartName(p.partType, p.orientation)
);
const combined = this.#formatListWithLeadingPossessive(partNames, 'my');
```

### Data Files to Modify

Remove `"orientation": "upper"` from neck socket in:

1. `data/mods/anatomy/entities/definitions/cat_girl_torso.entity.json`
2. `data/mods/anatomy/entities/definitions/human_female_torso.entity.json`
3. `data/mods/anatomy/entities/definitions/human_female_torso_hourglass_soft.entity.json`
4. `data/mods/anatomy/entities/definitions/human_female_torso_hulking.entity.json`
5. `data/mods/anatomy/entities/definitions/human_female_torso_muscular_scarred.entity.json`
6. `data/mods/anatomy/entities/definitions/human_female_torso_slim.entity.json`
7. `data/mods/anatomy/entities/definitions/human_female_torso_stocky.entity.json`
8. `data/mods/anatomy/entities/definitions/human_futa_torso.entity.json`
9. `data/mods/anatomy/entities/definitions/human_futa_torso_hulking_scarred.entity.json`

## Test Requirements

### Unit Tests

Add tests for grouped dismemberment formatting:
- Single dismembered part uses "is missing"
- Two dismembered parts use "are missing" with "and"
- Three+ dismembered parts use Oxford comma and "are missing"
- Only first part receives "My" prefix

Update bleeding tests:
- Verify only first part has "my" prefix
- Update expected outputs from `my torso and my head` to `my torso and head`

### Integration Tests

Update expected narrative outputs in:
- `tests/integration/anatomy/physicalConditionNarrativeImprovements.integration.test.js`

Add comprehensive test scenario:
- Multiple dismembered parts with various orientations
- Verify single grouped sentence output
- Verify correct grammar (is/are)

## Example Outputs

### Before Changes

```
My left ass cheek is missing. My right leg is missing. My right arm is missing. My right ear is missing. My vagina is missing. My left breast is missing. My torso is completely numb. My left leg aches deeply. My upper head throbs painfully. Blood flows steadily from my torso, my left leg, and my upper head.
```

### After Changes

```
My left ass cheek, right leg, right arm, right ear, vagina, and left breast are missing. My torso is completely numb. My left leg aches deeply. My head throbs painfully. Blood flows steadily from my torso, left leg, and head.
```

## Validation

After implementation, run:

```bash
npm run test:unit -- --testPathPattern=injuryNarrativeFormatterService
npm run test:integration -- --testPathPattern=physicalCondition
npx eslint src/anatomy/services/injuryNarrativeFormatterService.js
npm run typecheck
```

## Backward Compatibility

These changes are NOT backward compatible for:
- Tests expecting multiple individual "is missing" sentences
- Tests expecting redundant "my" in bleeding lists
- Tests expecting "upper head" in narrative output

All affected tests must be updated to match new expected formats.
