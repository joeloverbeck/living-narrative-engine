# Anatomy V2 Validation Alignment Specification

## Implementation Status

**Status**: PROPOSED â€“ Bug Fix
**Date**: 2025-02-14
**Version**: 1.0.0
**Author**: AI Architecture Support

## 1. Overview

### 1.1 Executive Summary

Loading the new anatomy V2 content fails during mod validation because multiple runtime validators still enforce legacy V1 data shapes. This specification aligns the validation layer with the documented V2 formats so that the new dragon, spider, and other non-human assets can be processed without schema errors.

### 1.2 Current Symptoms

- `anatomy:sockets` component validation rejects quadrupedal socket orientations generated by structure templates.
- `AnatomyRecipeLoader` throws `Invalid 'requires' group` because it still expects array-based groups instead of the documented object form.
- Recipes using the documented `matchesPattern` syntax fail schema validation even though the docs explicitly allow wildcards at the start, end, or middle of the pattern.

### 1.3 Affected Assets

- Component schema: `data/mods/anatomy/components/sockets.component.json`
- Loader: `src/loaders/anatomyRecipeLoader.js`
- Recipe schema: `data/schemas/anatomy.recipe.schema.json`
- Representative recipes/entities under `data/mods/anatomy/`
- Anatomy documentation under `docs/anatomy/`

## 2. Root Cause Analysis

### 2.1 Socket Orientation Enumeration Drift

The `anatomy:sockets` component schema still limits `orientation` to a small enum (`left`, `right`, `front`, `back`, etc.), but structure templates now emit labels such as `left_front`, `right_front`, `left_rear`, `right_rear`, and other composite orientations for quadrupeds and custom arrangements. Because the loader validates component payloads against the outdated enum, any entity that uses V2 templates fails to load.

### 2.2 Constraint Group Shape Mismatch

`AnatomyRecipeLoader._validateConstraints` still assumes `requires`/`excludes` are arrays of arrays (a V1 convention). The V2 schema and docs migrated these groups to object maps that declare `partTypes` and/or `components`. The hard-coded array check therefore raises `Invalid 'requires' group` even when the JSON follows the published schema.

### 2.3 Wildcard Pattern Restriction

The `matchesPattern` property is documented to accept prefix, suffix, or infix wildcards (`"leg_*"`, `"*_left"`, `"*tentacle*"`). The schema currently enforces `^[a-z0-9_]+\*?$`, which only allows an optional trailing wildcard. Ajv consequently interprets V2 patterns as invalid, causing schema validation to fail before runtime logic can execute.

## 3. Proposed Fix

### 3.1 Update Socket Schema

- Replace the hard-coded enum with a pattern-based validator that accepts lowercase alphanumerics with underscores (`^[a-z0-9_]+$`).
- Retain documentation about canonical orientations by referencing `docs/anatomy/structure-templates.md`, but allow any orientation emitted by template logic, including `left_front` and future composite names.
- Extend unit tests in `tests/unit/schemas/core.allComponents.schema.test.js` to cover a quadrupedal orientation example so regressions are caught.

### 3.2 Align Loader Constraint Validation

- Refactor `_validateConstraints` to treat each group as an object. Accept the keys defined in `anatomy.recipe.schema.json` (`partTypes`, `components`) and ensure each populated array has at least two entries.
- Preserve defensive checks for array types and empty objects; emit targeted error messages when a group omits both properties or uses invalid data types.
- Add loader-level tests (unit or integration) that feed in V2-style constraint objects to confirm acceptance while ensuring invalid arrays still fail.

### 3.3 Relax Recipe Pattern Regex

- Update the `matchesPattern` regex in `anatomy.recipe.schema.json` to allow leading/trailing/bisected wildcards (e.g., `^(\*|[a-z0-9_]+)(\*[a-z0-9_]+)*\*?$` or equivalent simplified expression).
- Ensure the schema still forbids empty strings and double wildcards without anchors (`"**"`).
- Backfill schema-focused tests that assert valid examples from `docs/anatomy/recipe-patterns.md` (prefix, suffix, infix) pass, while overly broad patterns like `"*"` still fail.

## 4. Acceptance Criteria

1. Loading `game.html` (or running `npm run validate`) no longer throws component or recipe validation errors for the anatomy mod.
2. Entities built from structure templates that emit composite orientations successfully validate their sockets component data.
3. Anatomy recipes with object-based `requires` groups pass loader validation while malformed payloads still produce helpful errors.
4. Wildcard patterns showcased in the anatomy documentation pass schema validation; invalid patterns are rejected with precise error messages.
5. Updated or new automated tests cover the above scenarios to prevent regressions.

## 5. Open Questions

- Should we capture the set of canonical orientation strings in documentation or telemetry to aid content authors? (Non-blocking for this fix.)
- Do we need migration tooling for legacy mods that still use the array-of-arrays `requires` format, or are we standardizing solely on the new object shape?

