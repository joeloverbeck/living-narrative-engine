<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Prototype Overlap Analysis - Living Narrative Engine</title>
  <link rel="stylesheet" href="css/style.css" />
  <link rel="stylesheet" href="css/prototype-analysis.css" />
</head>
<body>
  <div class="diagnostics-container">
    <header class="diagnostics-header">
      <h1>Prototype Overlap Analysis</h1>
      <button id="back-button" class="menu-button">Back to Menu</button>
    </header>

    <main class="diagnostics-main">
      <!-- Controls Panel -->
      <section class="panel controls-panel">
        <h2>Analysis Controls</h2>
        <div class="form-group">
          <label for="prototype-family">Prototype Family:</label>
          <select id="prototype-family" class="form-select">
            <option value="emotion">Emotions</option>
            <option value="sexual">Sexual States</option>
            <option value="both">Both (Combined)</option>
          </select>
        </div>
        <button id="run-analysis-btn" class="action-button" disabled>
          Run Analysis
        </button>
      </section>

      <!-- Progress Panel (hidden by default) -->
      <section id="progress-panel" class="panel progress-panel" hidden>
        <h2>Analysis Progress</h2>
        <div class="progress-bar-container">
          <div id="progress-bar" class="progress-bar" role="progressbar"
               aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
          </div>
        </div>
        <p id="progress-status" class="progress-status">Initializing...</p>
      </section>

      <!-- Results Panel (hidden by default) -->
      <section id="results-panel" class="panel results-panel" hidden>
        <h2>Analysis Results</h2>
        <div id="results-metadata" class="results-metadata"></div>
        <div id="recommendations-container" class="recommendations-container">
          <!-- Recommendation cards will be inserted here -->
        </div>
        <div id="empty-state" class="empty-state" hidden>
          <p>No overlapping prototypes detected. All prototypes are sufficiently distinct.</p>
        </div>
      </section>

      <!-- Axis Gap Analysis Panel (hidden by default) -->
      <section id="axis-gap-panel" class="panel axis-gap-panel" hidden>
        <h2>Axis Space Analysis</h2>

        <div class="axis-gap-summary">
          <div class="summary-item">
            <span class="summary-label">Prototypes Analyzed:</span>
            <span id="axis-gap-total-prototypes" class="summary-value">--</span>
          </div>
          <div class="summary-item">
            <span class="summary-label">Recommendations:</span>
            <span id="axis-gap-recommendations" class="summary-value">--</span>
          </div>
          <div class="summary-item">
            <span class="summary-label">Confidence:</span>
            <span id="axis-gap-confidence" class="summary-value confidence-badge">--</span>
            <span class="help-text" title="Low: 0-1 detection methods triggered | Medium: 2 methods | High: 3-4 methods">(?)</span>
          </div>
        </div>
        <p class="confidence-explanation">
          Confidence reflects how many independent detection methods agree:
          <strong>Low</strong> (0-1 methods), <strong>Medium</strong> (2 methods), <strong>High</strong> (3-4 methods).
        </p>

        <div id="decision-panel" class="decision-panel">
          <div class="decision-header">
            <span class="decision-label">New Axis Recommended?</span>
            <span id="decision-verdict" class="decision-badge verdict-no">NO</span>
          </div>
          <p id="decision-rationale" class="decision-rationale">Analysis not yet run.</p>
          <details class="decision-logic-details">
            <summary>How is this determined?</summary>
            <ul class="decision-criteria">
              <li><strong>YES:</strong> (High residual AND coverage gaps) OR (Hub prototypes AND multi-axis conflicts)</li>
              <li><strong>MAYBE:</strong> High residual alone, OR any other single signal</li>
              <li><strong>NO:</strong> Residual ≤15% AND no detection signals</li>
            </ul>
            <p class="logic-emphasis">
              <em>Important:</em> PCA uses <strong>OR</strong> logic for triggering. High residual variance (>15%)
              alone is sufficient for MAYBE verdict, regardless of "Additional Components" count.
            </p>
          </details>
          <div class="variance-summary-container">
            <div class="variance-summary">
              <span class="variance-label">Explained by top 4 PCs:</span>
              <span id="variance-top4" class="variance-value">--</span>
              <span class="help-icon" title="Quick reference: variance from first 4 principal components.">(?)</span>
            </div>
            <div class="variance-summary variance-dynamic">
              <span class="variance-label">Expected axis count (K):</span>
              <span id="variance-axis-count" class="variance-value">--</span>
              <span class="help-icon" title="Median active axes per prototype. Used for residual calculation.">(?)</span>
            </div>
            <div class="variance-summary variance-dynamic">
              <span class="variance-label">Explained by top K PCs:</span>
              <span id="variance-topk" class="variance-value">--</span>
              <span class="help-icon" title="Variance explained by first K components. Residual = 100% - this value.">(?)</span>
            </div>
          </div>
        </div>

        <div class="signal-breakdown">
          <h4>Signal Sources</h4>
          <div class="signal-grid">
            <div class="signal-item" id="signal-pca-item">
              <span id="signal-pca-status" class="signal-status pass">✓ PASS</span>
              <span class="signal-label">PCA Analysis:</span>
              <span id="signal-pca" class="signal-value">0</span>
              <span id="signal-pca-threshold" class="signal-threshold">(residual ≤15%)</span>
            </div>
            <div class="signal-item" id="signal-hubs-item">
              <span id="signal-hubs-status" class="signal-status pass">✓ PASS</span>
              <span class="signal-label">Hub Prototypes:</span>
              <span id="signal-hubs" class="signal-value">0</span>
              <span id="signal-hubs-threshold" class="signal-threshold">(no connectors)</span>
            </div>
            <div class="signal-item" id="signal-coverage-gaps-item">
              <span id="signal-coverage-gaps-status" class="signal-status pass">✓ PASS</span>
              <span class="signal-label">Coverage Gaps:</span>
              <span id="signal-coverage-gaps" class="signal-value">0</span>
              <span id="signal-coverage-gaps-threshold" class="signal-threshold"></span>
            </div>
            <div class="signal-item" id="signal-multi-axis-conflicts-item">
              <span id="signal-multi-axis-conflicts-status" class="signal-status pass">✓ PASS</span>
              <span class="signal-label">Multi-Axis Conflicts:</span>
              <span id="signal-multi-axis-conflicts" class="signal-value">0</span>
              <span id="signal-multi-axis-conflicts-threshold" class="signal-threshold">(high axis count)</span>
            </div>
          </div>
          <div class="signal-logic-explanation">
            <p class="logic-note">
              <strong>Detection Logic:</strong> PCA signal triggers when residual variance >15%
              <strong>OR</strong> additional components >0. Either condition alone is sufficient
              for triggering INVESTIGATE recommendations.
            </p>
          </div>
        </div>

        <div class="pca-summary">
          <h3>Dimensionality Analysis (PCA)</h3>
          <p class="section-description">
            Principal Component Analysis reveals whether the current axis set captures prototype variance.
            High residual variance suggests missing dimensions.
          </p>
          <div class="metric-row">
            <span class="metric-label">Residual Variance:</span>
            <span id="residual-variance" class="metric-value">--</span>
            <span class="help-text" title="Variance not explained by current axes. >15% (alert): likely missing important dimensions. 10-15% (warning): consider adding axes. <10% (good): current axes adequate.">(?)</span>
          </div>
          <div class="metric-row">
            <span class="metric-label">Significant Components (Broken-Stick):</span>
            <span id="significant-component-count" class="metric-value">--</span>
            <span class="help-text" title="Total components with variance exceeding broken-stick random expectation.">(?)</span>
          </div>
          <div class="metric-row">
            <span class="metric-label">Expected Components (K):</span>
            <span id="expected-component-count" class="metric-value">--</span>
            <span class="help-text" title="Median active axes per prototype (expected dimensionality).">(?)</span>
          </div>
          <div class="metric-row">
            <span class="metric-label">Significant Beyond K:</span>
            <span id="significant-beyond-expected" class="metric-value">--</span>
            <span class="help-text" title="Significant minus Expected. If 0, significant count matches expected - check residual variance for the full picture.">(?)</span>
          </div>
          <div class="metric-row">
            <span class="metric-label">Components for 80% Variance:</span>
            <span id="components-for-80" class="metric-value">--</span>
            <span class="help-text" title="Number of principal components needed to explain 80% of total variance. Lower is better - fewer dimensions capture most information.">(?)</span>
          </div>
          <div class="metric-row">
            <span class="metric-label">Components for 90% Variance:</span>
            <span id="components-for-90" class="metric-value">--</span>
            <span class="help-text" title="Number of principal components needed to explain 90% of total variance. Compare with current axis count to gauge dimensionality adequacy.">(?)</span>
          </div>
          <div id="pca-dimensions-list" class="dimensions-list"></div>
          <div id="pca-top-loading" class="top-loading-list"></div>
          <div id="poorly-fitting-prototypes" class="poorly-fitting-section">
            <h4>Poorly Fitting Prototypes</h4>
            <p class="pca-subtitle">Prototypes with highest reconstruction error (don't fit well in current axis space)</p>
            <ul id="poorly-fitting-list" class="poorly-fitting-list"></ul>
          </div>
        </div>

        <div class="hub-prototypes">
          <h3>Hub Prototypes</h3>
          <p class="section-description">
            Prototypes connecting multiple clusters may indicate missing dimensions.
          </p>
          <ul id="hub-list" class="prototype-list"></ul>
        </div>

        <div class="coverage-gaps">
          <h3>Coverage Gaps</h3>
          <p class="section-description">
            Behaviorally-similar prototype clusters (grouped by k-means, not dominant axis)
            whose weight centroids don't align well with any existing axis.
          </p>
          <ul id="coverage-gap-list" class="gap-list"></ul>
        </div>

        <div class="multi-axis-conflicts">
          <h3>Multi-Axis Conflicts</h3>
          <p class="section-description">
            Prototypes with unusually high axis counts (statistical outliers via Tukey's fence).
          </p>
          <ul id="conflict-list" class="conflict-list"></ul>
        </div>

        <div class="sign-tensions-section informational-section">
          <h3>Sign Tensions <span class="metadata-badge">(Informational)</span></h3>
          <p class="section-description informational-notice">
            <strong>Note:</strong> Mixed positive/negative weights are <em>normal</em> for emotional prototypes.
            This section shows structural patterns for understanding, not defects requiring action.
            Sign tensions do not contribute to confidence scoring or recommendations.
          </p>
          <ul id="sign-tension-list" class="sign-tension-list metadata-list"></ul>
        </div>

        <div class="axis-recommendations">
          <h3>Axis Recommendations</h3>
          <ul id="axis-recommendations-list" class="axis-recommendations-list"></ul>
        </div>

        <div class="candidate-axis-section">
          <h3>Candidate Axis Validation</h3>
          <p class="section-description">
            Would adding a new axis help? Tests potential axis directions against improvement metrics.
          </p>
          <ul id="candidate-axis-list"></ul>
        </div>

        <div class="prototype-weight-cards">
          <h3>Flagged Prototypes Analysis</h3>
          <p class="section-description">
            Prototypes flagged by detection methods with their dominant axis weights.
          </p>
          <div id="prototype-cards-container" class="prototype-cards-container"></div>
        </div>
      </section>
    </main>
  </div>

  <script src="prototype-analysis.js"></script>
</body>
</html>
