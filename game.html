<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Adventure Game Platform - Storyteller's Desk</title>
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png" />
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png" />
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png" />
    <link rel="manifest" href="/site.webmanifest" />
    <link
      href="https://fonts.googleapis.com/css2?family=Merriweather:ital,wght@0,400;0,700;1,400&family=Open+Sans:wght@400;600;700&family=Roboto+Mono:wght@400;500&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="css/style.css" />
  </head>

  <body>
    <div
      id="turn-order-ticker"
      role="region"
      aria-label="Turn order"
      aria-live="polite"
    >
      <div class="ticker-round-label">
        <span id="ticker-round-number">ROUND 1</span>
      </div>
      <div id="ticker-actor-queue" class="ticker-actor-queue">
        <!-- Actor elements dynamically inserted here -->
      </div>
    </div>

    <div id="app-layout-container">
      <aside id="left-pane" class="panel">
        <div
          id="current-turn-actor-panel"
          class="widget"
          role="region"
          aria-labelledby="current-turn-actor-heading"
        >
          <h3 id="current-turn-actor-heading">Current Turn</h3>
          <div class="actor-visuals">
            <img
              id="current-actor-image"
              src=""
              alt="Current Actor Portrait"
              style="display: none"
            />
          </div>
          <p id="current-actor-name" class="actor-name-display">N/A</p>
        </div>
        <div
          id="injury-status-widget"
          class="widget"
          role="region"
          aria-labelledby="injury-status-heading"
          aria-live="polite"
        >
          <h3 id="injury-status-heading">Physical Condition</h3>
          <div id="injury-status-content">
            <div id="injury-narrative"></div>
          </div>
        </div>
        <div
          id="perception-log-widget"
          role="region"
          aria-labelledby="perception-log-heading"
          aria-live="polite"
        >
          <h3 id="perception-log-heading">Perception Log</h3>
          <div id="perception-log-content"></div>
        </div>
      </aside>

      <main
        id="center-pane"
        class="panel"
        role="main"
        aria-label="Main content area"
      >
        <div id="outputDiv">
          <ul id="message-list" aria-live="polite"></ul>
          <div
            id="processing-indicator"
            class="processing-indicator"
            aria-live="polite"
            aria-label="Processing turn"
          >
            <span class="dot"></span><span class="dot"></span
            ><span class="dot"></span>
          </div>
        </div>
        <div
          id="actions-widget"
          role="region"
          aria-labelledby="actions-heading"
        >
          <h3 id="actions-heading">Actions</h3>
          <div id="action-buttons"></div>
        </div>
      </main>

      <aside id="right-pane" class="panel">
        <!-- LOCATION INFO -->
        <div
          id="location-info-container"
          role="region"
          aria-labelledby="location-name-display"
          aria-live="polite"
          aria-atomic="true"
        >
          <!-- Card 1 · Name + Summary (portrait+description share the same card) -->
          <section
            id="location-summary-card"
            class="location-card non-collapsible"
          >
            <h2 id="location-name-display"></h2>

            <!-- portrait (hidden if none) -->
            <div id="location-portrait-visuals" class="location-visuals">
              <img
                id="location-portrait-image"
                src=""
                alt="Location Image"
                style="display: none"
              />
              <!-- tooltip will be injected here by JS -->
            </div>

            <!-- description paragraph (shown only when no portrait) -->
            <p id="location-description-display"></p>
          </section>

          <!-- Card 2 · Exits (accordion) -->
          <details id="location-exits-card" class="location-card" open>
            <summary>Exits</summary>
            <div id="location-exits-display"></div>
          </details>

          <!-- Card 3 · Characters (accordion) -->
          <details id="location-characters-card" class="location-card" open>
            <summary>Characters</summary>
            <div id="location-characters-display"></div>
          </details>
        </div>

        <!-- ACTOR PARTICIPATION CONTROL -->
        <div
          id="actor-participation-widget"
          class="widget"
          role="region"
          aria-labelledby="actor-participation-heading"
        >
          <h3 id="actor-participation-heading">Actor Participation Control</h3>

          <!-- Actor list will be dynamically populated here -->
          <div id="actor-participation-list-container" class="actor-list"></div>

          <!-- Status message area -->
          <div
            id="actor-participation-status"
            class="status-message-area"
            role="status"
            aria-live="polite"
            aria-atomic="true"
          ></div>
        </div>

        <!-- PERCEPTIBLE EVENT SENDER -->
        <div
          id="perceptible-event-sender-widget"
          class="widget"
          role="region"
          aria-labelledby="perceptible-event-heading"
        >
          <h3 id="perceptible-event-heading">Send Perceptible Event</h3>

          <!-- Message Input -->
          <div class="form-group">
            <label for="perceptible-event-message">Event Message</label>
            <textarea
              id="perceptible-event-message"
              class="perceptible-event-textarea"
              placeholder="Enter event description (e.g., 'A loud crash echoes from nearby')"
              rows="3"
              aria-describedby="message-help"
            ></textarea>
            <span id="message-help" class="help-text">
              Describe what actors in the location perceive
            </span>
          </div>

          <!-- Location Selector -->
          <div class="form-group">
            <label for="perceptible-event-location">Target Location</label>
            <select
              id="perceptible-event-location"
              class="perceptible-event-select"
              aria-describedby="location-help"
            >
              <option value="">-- Select Location --</option>
            </select>
            <span id="location-help" class="help-text">
              Location where event will be perceived
            </span>
          </div>

          <!-- Recipient Filter (Optional) -->
          <details class="filter-section">
            <summary>Advanced Filters (Optional)</summary>

            <div class="filter-group">
              <label>
                <input
                  type="radio"
                  name="filter-mode"
                  value="all"
                  checked
                  aria-describedby="filter-mode-help"
                />
                All actors in location
              </label>

              <label>
                <input type="radio" name="filter-mode" value="specific" />
                Specific actors only
              </label>

              <label>
                <input type="radio" name="filter-mode" value="exclude" />
                Exclude specific actors
              </label>
            </div>

            <div id="actor-filter-container" style="display: none">
              <select
                id="perceptible-event-actors"
                class="perceptible-event-select"
                multiple
                size="4"
                aria-label="Select actors"
              ></select>
            </div>

            <span id="filter-mode-help" class="help-text">
              Choose who perceives the event
            </span>
          </details>

          <!-- Send Button -->
          <button
            type="button"
            id="send-perceptible-event-button"
            class="button-primary"
            disabled
          >
            Send Event
          </button>

          <!-- Status Message -->
          <div
            id="perceptible-event-status"
            class="status-message-area"
            role="status"
            aria-live="polite"
          ></div>
        </div>

        <!-- LLM PROMPT DEBUG widget -->
        <div
          id="llm-prompt-debug-widget"
          class="widget"
          role="region"
          aria-labelledby="llm-prompt-debug-heading"
        >
          <h3 id="llm-prompt-debug-heading">LLM Prompt Debug</h3>
          <button
            type="button"
            id="llm-prompt-debug-button"
            class="menu-button"
          >
            Prompt to LLM
          </button>
        </div>

        <!-- GAME-ACTIONS widget (unchanged) -->
        <div
          id="game-actions-widget"
          role="region"
          aria-labelledby="game-actions-heading"
        >
          <h3 id="game-actions-heading">Game Menu</h3>
          <button type="button" id="change-llm-button" class="menu-button">
            Change LLM
          </button>
        </div>

        <!-- ENTITY LIFECYCLE MONITOR - DISABLED -->
        <div
          id="entity-lifecycle-monitor"
          class="widget entity-lifecycle-widget"
          role="region"
          aria-labelledby="entity-lifecycle-heading"
          aria-live="polite"
          style="display: none"
        >
          <h3 id="entity-lifecycle-heading">Entity Lifecycle Monitor</h3>
          <!-- Event list will be dynamically inserted here -->
        </div>
      </aside>
    </div>

    <footer id="bottom-input-bar">
      <div id="input-container">
        <label for="speech-input" class="visually-hidden">Enter command</label>
        <input
          type="text"
          id="speech-input"
          placeholder="Loading..."
          disabled
        />
      </div>
      <button type="button" id="player-confirm-turn-button">
        Confirm Action
      </button>
    </footer>

    <div
      id="error-output"
      class="error"
      role="alert"
      aria-live="assertive"
    ></div>

    <div
      id="llm-selection-modal"
      class="modal-overlay"
      role="dialog"
      aria-labelledby="llm-selection-modal-title"
      aria-modal="true"
      style="display: none"
    >
      <div class="modal-content">
        <h2 id="llm-selection-modal-title" class="modal-title">
          Select Language Model
        </h2>
        <div
          id="llm-selection-list-container"
          role="radiogroup"
          aria-labelledby="llm-selection-list-label"
        >
          <p id="llm-selection-list-label" class="visually-hidden">
            Available Language Models
          </p>
          <ul id="llm-selection-list"></ul>
        </div>
        <div
          id="llm-selection-status-message"
          class="status-message-area"
          role="status"
          aria-live="polite"
        ></div>
        <div class="modal-actions">
          <button
            type="button"
            id="llm-selection-modal-close-button"
            class="button-secondary"
          >
            Cancel
          </button>
        </div>
      </div>
    </div>

    <!-- LLM Prompt Debug Modal -->
    <div
      id="llm-prompt-debug-modal"
      class="modal-overlay"
      role="dialog"
      aria-labelledby="llm-prompt-debug-title"
      aria-modal="true"
      style="display: none"
    >
      <div class="modal-content">
        <h2 id="llm-prompt-debug-title" class="modal-title">
          LLM Prompt Preview
        </h2>

        <div
          id="llm-prompt-debug-status"
          class="status-message-area"
          role="status"
          aria-live="polite"
        ></div>

        <div id="llm-prompt-debug-metadata" class="prompt-metadata">
          <div class="prompt-meta-item">
            <span class="prompt-meta-label">Actor:</span>
            <span id="llm-prompt-meta-actor" class="prompt-meta-value">-</span>
          </div>
          <div class="prompt-meta-item">
            <span class="prompt-meta-label">LLM:</span>
            <span id="llm-prompt-meta-llm" class="prompt-meta-value">-</span>
          </div>
          <div class="prompt-meta-item">
            <span class="prompt-meta-label">Actions:</span>
            <span id="llm-prompt-meta-actions" class="prompt-meta-value"
              >-</span
            >
          </div>
        </div>

        <div id="llm-prompt-debug-content-container">
          <pre id="llm-prompt-debug-content" tabindex="0"></pre>
        </div>

        <div class="modal-actions">
          <button
            type="button"
            id="llm-prompt-copy-button"
            class="button-primary"
          >
            Copy to Clipboard
          </button>
          <button
            type="button"
            id="llm-prompt-debug-close-button"
            class="button-secondary"
          >
            Close
          </button>
        </div>
      </div>
    </div>

    <!-- Portrait Modal - Character portrait viewer -->
    <div
      class="portrait-modal-overlay modal-overlay"
      role="dialog"
      aria-modal="true"
      aria-labelledby="portrait-modal-title"
      aria-describedby="portrait-modal-description"
      style="display: none"
    >
      <div class="portrait-modal-content modal-content">
        <!-- Modal Header -->
        <div class="portrait-modal-header">
          <h2 id="portrait-modal-title" class="portrait-modal-title">
            Character Portrait
          </h2>
          <button
            class="portrait-modal-close"
            aria-label="Close portrait modal"
            type="button"
          >
            <span aria-hidden="true">&times;</span>
          </button>
        </div>

        <!-- Modal Body -->
        <div class="portrait-modal-body">
          <div class="portrait-image-container">
            <!-- Loading Spinner -->
            <div
              class="portrait-loading-spinner"
              role="status"
              aria-live="polite"
            >
              <span class="visually-hidden">Loading portrait...</span>
              <span aria-hidden="true">Loading...</span>
            </div>

            <!-- Main Portrait Image -->
            <img
              class="portrait-modal-image"
              src=""
              alt=""
              role="img"
              aria-describedby="portrait-modal-description"
            />

            <!-- Error Message -->
            <div
              class="portrait-error-message"
              role="alert"
              aria-live="assertive"
              style="display: none"
            >
              <span class="error-icon" aria-hidden="true">⚠️</span>
              <span class="error-text">Failed to load portrait</span>
            </div>
          </div>
        </div>

        <!-- Hidden description for screen readers -->
        <div id="portrait-modal-description" class="visually-hidden">
          High resolution portrait image viewer for character artwork
        </div>
      </div>
    </div>

    <script src="bundle.js"></script>
    <script>
      window.bootstrapApp().then(() => {
        const params = new URLSearchParams(window.location.search);
        if (params.get('start') !== 'false') {
          window.beginGame();
        }
      });
    </script>
  </body>
</html>
