<!doctype html>
<html>
  <head>
    <title>Browser Trace Test</title>
  </head>
  <body>
    <h1>Browser Trace Write Test</h1>
    <button id="testBtn">Test Trace Write</button>
    <pre id="output"></pre>

    <script>
      document.getElementById('testBtn').addEventListener('click', async () => {
        const output = document.getElementById('output');
        output.textContent = 'Testing trace write from browser...\n';

        const traceData = {
          timestamp: new Date().toISOString(),
          outputDirectory: './traces/rub-vagina-debugging',
          trace: {
            actionId: 'sex:rub_vagina_over_clothes',
            actorId: 'browser_test',
            pipeline: {
              componentFiltering: { duration: 2.5, passed: true },
              prerequisiteEvaluation: { duration: 5.3, result: true },
              targetResolution: { duration: 8.7, resolvedTargets: [] },
              formatting: { duration: 1.2, formattedCommand: 'test command' },
            },
            execution: { duration: 102, result: 'success' },
          },
          metadata: {
            actionId: 'sex:rub_vagina_over_clothes',
            actorId: 'browser_test',
            isComplete: true,
            hasError: false,
            generatedBy: 'Browser Test',
          },
        };

        const fileName = `trace_browser_test_${Date.now()}.json`;

        try {
          console.log('Sending trace to server:', fileName);
          const response = await fetch(
            'http://localhost:3001/api/traces/write',
            {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
              },
              body: JSON.stringify({
                traceData: JSON.stringify(traceData, null, 2),
                fileName: fileName,
                outputDirectory: './traces/rub-vagina-debugging',
              }),
            }
          );

          if (!response.ok) {
            const error = await response.text();
            output.textContent += `Error ${response.status}: ${error}\n`;
            console.error('Server error:', error);
          } else {
            const result = await response.json();
            output.textContent += `Success!\n`;
            output.textContent += `Path: ${result.path}\n`;
            output.textContent += `Size: ${result.size} bytes\n`;
            console.log('Trace written successfully:', result);
          }
        } catch (error) {
          output.textContent += `Error: ${error.message}\n`;
          console.error('Fetch error:', error);
          if (error.message.includes('Failed to fetch')) {
            output.textContent +=
              'Server appears to be offline or CORS issue\n';
          }
        }
      });
    </script>
  </body>
</html>
